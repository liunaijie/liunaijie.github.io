<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta property="og:url" content="https://www.liunaijie.top/publish/spark%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B/">
  <meta property="og:site_name" content="Jarvis`s library">
  <meta property="og:title" content="Spark源码解析-(一)提交流程">
  <meta property="og:description" content="本文以Spark3.4版本，提交任务方式为Yarn Cluster，以JavaWordCount这个应用程序为例来分析一下一个Spark任务的提交过程。 过程中会对代码做一些删减，主要目的是了解从用户提交任务开始到一个任务如何开始运行. 本文主要记录两种提交任务的方式，spark-submit.sh与SparkLauncher.
Spark-submit.sh 以需要执行JavaWordCount为例，启动命令为：
1 2 3 4 5 6 ./bin/spark-submit \ --master yarn \ --deploy-mode cluster \ --class org.apache.spark.examples.JavaWordCount \ /path/to/examples.jar \ /tmp/file1.txt 我们指定了在yarn上以cluster模式启动JavaWordCount程序， 指定了jar包位置，以及要读取的文件
spark-submit 1 2 3 ...... exec &#34;${SPARK_HOME}&#34;/bin/spark-class org.apache.spark.deploy.SparkSubmit &#34;$@&#34; 这个脚本最后调用了spark-class脚本，第一个参数为SparkSubmit的全类名，再加上我们本来的参数
spark-class 这个脚本做了这几件事：
查找spark的jar包 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # Find Spark jars. if [ -d &#34;${SPARK_HOME}/jars&#34; ]; then SPARK_JARS_DIR=&#34;${SPARK_HOME}/jars&#34; else SPARK_JARS_DIR=&#34;${SPARK_HOME}/assembly/target/scala-$SPARK_SCALA_VERSION/jars&#34; fi if [ ! -d &#34;$SPARK_JARS_DIR&#34; ] &amp;&amp; [ -z &#34;$SPARK_TESTING$SPARK_SQL_TESTING&#34; ]; then echo &#34;Failed to find Spark jars directory ($SPARK_JARS_DIR).&#34; 1&gt;&amp;2 echo &#34;You need to build Spark with the target \&#34;package\&#34; before running this program.&#34; 1&gt;&amp;2 exit 1 else LAUNCH_CLASSPATH=&#34;$SPARK_JARS_DIR/*&#34; fi # Add the launcher build dir to the classpath if requested. if [ -n &#34;$SPARK_PREPEND_CLASSES&#34; ]; then LAUNCH_CLASSPATH=&#34;${SPARK_HOME}/launcher/target/scala-$SPARK_SCALA_VERSION/classes:$LAUNCH_CLASSPATH&#34; fi 调用SparkLauncher里面的Main进行参数注入 1 2 3 4 build_command() { &#34;$RUNNER&#34; -Xmx128m $SPARK_LAUNCHER_OPTS -cp &#34;$LAUNCH_CLASSPATH&#34; org.apache.spark.launcher.Main &#34;$@&#34; printf &#34;%d\0&#34; $? } 执行被修改过的命令 1 2 CMD=(&#34;${CMD[@]:0:$LAST}&#34;) exec &#34;${CMD[@]}&#34; 经过修改后最终的命令为：">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="publish">
    <meta property="article:published_time" content="2023-07-22T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-07-22T00:00:00+00:00">
    <meta property="article:tag" content="Spark">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Spark源码解析-(一)提交流程">
  <meta name="twitter:description" content="本文以Spark3.4版本，提交任务方式为Yarn Cluster，以JavaWordCount这个应用程序为例来分析一下一个Spark任务的提交过程。 过程中会对代码做一些删减，主要目的是了解从用户提交任务开始到一个任务如何开始运行. 本文主要记录两种提交任务的方式，spark-submit.sh与SparkLauncher.
Spark-submit.sh 以需要执行JavaWordCount为例，启动命令为：
1 2 3 4 5 6 ./bin/spark-submit \ --master yarn \ --deploy-mode cluster \ --class org.apache.spark.examples.JavaWordCount \ /path/to/examples.jar \ /tmp/file1.txt 我们指定了在yarn上以cluster模式启动JavaWordCount程序， 指定了jar包位置，以及要读取的文件
spark-submit 1 2 3 ...... exec &#34;${SPARK_HOME}&#34;/bin/spark-class org.apache.spark.deploy.SparkSubmit &#34;$@&#34; 这个脚本最后调用了spark-class脚本，第一个参数为SparkSubmit的全类名，再加上我们本来的参数
spark-class 这个脚本做了这几件事：
查找spark的jar包 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # Find Spark jars. if [ -d &#34;${SPARK_HOME}/jars&#34; ]; then SPARK_JARS_DIR=&#34;${SPARK_HOME}/jars&#34; else SPARK_JARS_DIR=&#34;${SPARK_HOME}/assembly/target/scala-$SPARK_SCALA_VERSION/jars&#34; fi if [ ! -d &#34;$SPARK_JARS_DIR&#34; ] &amp;&amp; [ -z &#34;$SPARK_TESTING$SPARK_SQL_TESTING&#34; ]; then echo &#34;Failed to find Spark jars directory ($SPARK_JARS_DIR).&#34; 1&gt;&amp;2 echo &#34;You need to build Spark with the target \&#34;package\&#34; before running this program.&#34; 1&gt;&amp;2 exit 1 else LAUNCH_CLASSPATH=&#34;$SPARK_JARS_DIR/*&#34; fi # Add the launcher build dir to the classpath if requested. if [ -n &#34;$SPARK_PREPEND_CLASSES&#34; ]; then LAUNCH_CLASSPATH=&#34;${SPARK_HOME}/launcher/target/scala-$SPARK_SCALA_VERSION/classes:$LAUNCH_CLASSPATH&#34; fi 调用SparkLauncher里面的Main进行参数注入 1 2 3 4 build_command() { &#34;$RUNNER&#34; -Xmx128m $SPARK_LAUNCHER_OPTS -cp &#34;$LAUNCH_CLASSPATH&#34; org.apache.spark.launcher.Main &#34;$@&#34; printf &#34;%d\0&#34; $? } 执行被修改过的命令 1 2 CMD=(&#34;${CMD[@]:0:$LAST}&#34;) exec &#34;${CMD[@]}&#34; 经过修改后最终的命令为：">

  
  
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#181818">
  <title>
    
    Jarvis`s library - Spark源码解析-(一)提交流程
    
  </title>
  
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  
  
  
  <link rel="stylesheet" href="/minima.54cfcb44e10b4015b41a13771763013b79bdba6a92e49ea4a77bb44db465e761.css" integrity="sha256-VM/LROELQBW0GhN3F2MBO3m9umqS5J6kp3u0TbRl52E=">
  
  
  
  <script defer type="text/javascript" src="/minima.b4da24217e147f536fc7dc225886a1ea20bedabe7aed49e546a5d97cc34e4555.js" integrity="sha256-tNokIX4Uf1Nvx9wiWIah6iC&#43;2r567UnlRqXZfMNORVU="></script>
  
  
  
</head>
<script>
  const theme_config = 'system'
  const theme_light = theme_config === 'system' ? 'light' : theme_config;
  let theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : theme_light;
  console.debug(theme);

  try {
    localStorage.setItem('theme', theme);
    window.minima_theme = theme;
    document.querySelector('html').classList.add(theme);
  } catch (e) {
    console.error(e);
  }
</script>



<body>
  <header class="mt-3 mb-8">
  <div class="container mx-auto">
    <nav class="flex justify-between items-center">
      <div class="flex items-center">
        
        <div id="theme-switch" class="text-2xl cursor-pointer"></div>
      </div>
      <ul class="flex items-center text-base font-semibold
        whitespace-nowrap overflow-x-auto overflow-y-hidden">
        
        <li class="ml-2 mr-2">
          
          <a href='/'>首页</a>
          
        </li>
        
        <li class="ml-2 mr-2">
          
          <a href="/tags">标签</a>
          
        </li>
        
        <li class="ml-2 mr-2">
          
          <a href="/search">搜索</a>
          
        </li>
        
        <li class="ml-2 mr-2">
          
          <a href="/about">关于</a>
          
        </li>
        
      </ul>
      <ul class="flex item-center text-sm font-semibold">
        
        <li class="ml-2"><a href="https://www.liunaijie.top/"></a></li>
        
      </ul>
    </nav>
  </div>
</header>

  
<div class="container mx-auto">
  <h1 class="text-4xl font-extrabold mt-6 mb-6">Spark源码解析-(一)提交流程</h1>
  <div class="mb-3 text-sm flex justify-between ">
    <div>
      
      发布于 &mdash; 2023 年 07 月 22 日
      
      
    </div>
    
    <div>
      
      
      <a class="ml-1" href="/tags/spark">#spark</a>
      
    </div>
    
  </div>
  <main class="mb-8">
    <p></p>
    <article class="md">
      <p>本文以Spark3.4版本，提交任务方式为Yarn Cluster，以<code>JavaWordCount</code>这个应用程序为例来分析一下一个Spark任务的提交过程。
过程中会对代码做一些删减，主要目的是了解从用户提交任务开始到一个任务如何开始运行.
本文主要记录两种提交任务的方式，<code>spark-submit.sh</code>与<code>SparkLauncher</code>.</p>
<h1 id="spark-submitsh">Spark-submit.sh</h1>
<p>以需要执行JavaWordCount为例，启动命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./bin/spark-submit <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--master yarn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--deploy-mode cluster <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--class org.apache.spark.examples.JavaWordCount <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>/path/to/examples.jar <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>/tmp/file1.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们指定了在yarn上以cluster模式启动JavaWordCount程序， 指定了jar包位置，以及要读取的文件</p>
<h2 id="spark-submit">spark-submit</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SPARK_HOME</span><span class="si">}</span><span class="s2">&#34;</span>/bin/spark-class org.apache.spark.deploy.SparkSubmit <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个脚本最后调用了<code>spark-class</code>脚本，第一个参数为<code>SparkSubmit</code>的全类名，再加上我们本来的参数</p>
<h2 id="spark-class">spark-class</h2>
<p>这个脚本做了这几件事：</p>
<ul>
<li>查找spark的jar包</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># Find Spark jars.  </span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SPARK_HOME</span><span class="si">}</span><span class="s2">/jars&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  
</span></span><span class="line"><span class="cl"><span class="nv">SPARK_JARS_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">SPARK_HOME</span><span class="si">}</span><span class="s2">/jars&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="k">else</span>  
</span></span><span class="line"><span class="cl"><span class="nv">SPARK_JARS_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">SPARK_HOME</span><span class="si">}</span><span class="s2">/assembly/target/scala-</span><span class="nv">$SPARK_SCALA_VERSION</span><span class="s2">/jars&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="k">fi</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&#34;</span><span class="nv">$SPARK_JARS_DIR</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$SPARK_TESTING$SPARK_SQL_TESTING</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Failed to find Spark jars directory (</span><span class="nv">$SPARK_JARS_DIR</span><span class="s2">).&#34;</span> 1&gt;<span class="p">&amp;</span><span class="m">2</span>  
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;You need to build Spark with the target \&#34;package\&#34; before running this program.&#34;</span> 1&gt;<span class="p">&amp;</span><span class="m">2</span>  
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">1</span>  
</span></span><span class="line"><span class="cl"><span class="k">else</span>  
</span></span><span class="line"><span class="cl"><span class="nv">LAUNCH_CLASSPATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$SPARK_JARS_DIR</span><span class="s2">/*&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="k">fi</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># Add the launcher build dir to the classpath if requested.  </span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$SPARK_PREPEND_CLASSES</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  
</span></span><span class="line"><span class="cl"><span class="nv">LAUNCH_CLASSPATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">SPARK_HOME</span><span class="si">}</span><span class="s2">/launcher/target/scala-</span><span class="nv">$SPARK_SCALA_VERSION</span><span class="s2">/classes:</span><span class="nv">$LAUNCH_CLASSPATH</span><span class="s2">&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>调用SparkLauncher里面的Main进行参数注入</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">build_command<span class="o">()</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="nv">$RUNNER</span><span class="s2">&#34;</span> -Xmx128m <span class="nv">$SPARK_LAUNCHER_OPTS</span> -cp <span class="s2">&#34;</span><span class="nv">$LAUNCH_CLASSPATH</span><span class="s2">&#34;</span> org.apache.spark.launcher.Main <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">printf</span> <span class="s2">&#34;%d\0&#34;</span> <span class="nv">$?</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>执行被修改过的命令</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">CMD</span><span class="o">=(</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CMD</span><span class="p">[@]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">$LAST</span><span class="si">}</span><span class="s2">&#34;</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CMD</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>经过修改后最终的命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">java -cp
</span></span><span class="line"><span class="cl">....<span class="o">(</span>一些参数修改<span class="o">)</span>
</span></span><span class="line"><span class="cl">org.apache.spark.deploy.SparkSubmit <span class="se">\ </span>
</span></span><span class="line"><span class="cl">--master yarn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--deploy-mode cluster <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--class org.apache.spark.examples.JavaWordCount <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>/path/to/examples.jar <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>/tmp/file1.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到这里最终会去调用<code>SparkSubmit</code>这个类</p>
<h2 id="sparksubmit">SparkSubmit</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">override</span> <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">submit</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkSubmit</span><span class="o">()</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="n">self</span> <span class="k">=&gt;</span>  
</span></span><span class="line"><span class="cl">			<span class="k">override</span> <span class="k">def</span> <span class="n">doSubmit</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">			<span class="c1">// 调用 doSubmit方法  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">super</span><span class="o">.</span><span class="n">doSubmit</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">SparkUserAppException</span> <span class="o">=&gt;</span>  
</span></span><span class="line"><span class="cl">				<span class="n">exitFn</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">exitCode</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">			<span class="o">}</span>  
</span></span><span class="line"><span class="cl">		<span class="o">}</span>  
</span></span><span class="line"><span class="cl">	<span class="o">}</span>  
</span></span><span class="line"><span class="cl">	<span class="n">submit</span><span class="o">.</span><span class="n">doSubmit</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">[</span><span class="kt">spark</span><span class="o">]</span> <span class="k">class</span> <span class="nc">SparkSubmit</span> <span class="k">extends</span> <span class="nc">Logging</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">def</span> <span class="n">doSubmit</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="c1">// Initialize logging if it hasn&#39;t been done yet. Keep track of whether logging needs to  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// be reset before the application starts.  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">val</span> <span class="n">uninitLog</span> <span class="k">=</span> <span class="n">initializeLogIfNecessary</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">silent</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">		  
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">appArgs</span> <span class="k">=</span> <span class="n">parseArguments</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">appArgs</span><span class="o">.</span><span class="n">verbose</span><span class="o">)</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">			<span class="n">logInfo</span><span class="o">(</span><span class="n">appArgs</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">		<span class="o">}</span>  
</span></span><span class="line"><span class="cl">		<span class="c1">// action默认为submit，则会到submit方法  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">appArgs</span><span class="o">.</span><span class="n">action</span> <span class="k">match</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nc">SparkSubmitAction</span><span class="o">.</span><span class="nc">SUBMIT</span> <span class="k">=&gt;</span> <span class="n">submit</span><span class="o">(</span><span class="n">appArgs</span><span class="o">,</span> <span class="n">uninitLog</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nc">SparkSubmitAction</span><span class="o">.</span><span class="nc">KILL</span> <span class="k">=&gt;</span> <span class="n">kill</span><span class="o">(</span><span class="n">appArgs</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nc">SparkSubmitAction</span><span class="o">.</span><span class="nc">REQUEST_STATUS</span> <span class="k">=&gt;</span> <span class="n">requestStatus</span><span class="o">(</span><span class="n">appArgs</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nc">SparkSubmitAction</span><span class="o">.</span><span class="nc">PRINT_VERSION</span> <span class="k">=&gt;</span> <span class="n">printVersion</span><span class="o">()</span>  
</span></span><span class="line"><span class="cl">		<span class="o">}</span>  
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">private</span> <span class="k">def</span> <span class="n">submit</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">SparkSubmitArguments</span><span class="o">,</span> <span class="n">uninitLog</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="n">doRunMain</span><span class="o">()</span>  
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="k">def</span> <span class="n">doRunMain</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">			<span class="o">...</span>
</span></span><span class="line"><span class="cl">			<span class="n">runMain</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="n">uninitLog</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	 
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在Main方法中调用伴生类中的<code>doSubmit</code>方法，在<code>doSubmit</code>方法中先进行了参数解析，然后模式匹配，调用不同类型的方法。默认的action为submit，所以会调用到submit方法，而submit方法中又会调用到runMain方法中去.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">def</span> <span class="n">runMain</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">SparkSubmitArguments</span><span class="o">,</span> <span class="n">uninitLog</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="o">(</span><span class="n">childArgs</span><span class="o">,</span> <span class="n">childClasspath</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">,</span> <span class="n">childMainClass</span><span class="o">)</span> <span class="k">=</span> <span class="n">prepareSubmitEnvironment</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">loader</span> <span class="k">=</span> <span class="n">getSubmitClassLoader</span><span class="o">(</span><span class="n">sparkConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="o">(</span><span class="n">jar</span> <span class="k">&lt;-</span> <span class="n">childClasspath</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">addJarToClasspath</span><span class="o">(</span><span class="n">jar</span><span class="o">,</span> <span class="n">loader</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">mainClass</span><span class="k">:</span> <span class="kt">Class</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">mainClass</span> <span class="k">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="n">classForName</span><span class="o">(</span><span class="n">childMainClass</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">app</span><span class="k">:</span> <span class="kt">SparkApplication</span> <span class="o">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SparkApplication</span><span class="o">].</span><span class="n">isAssignableFrom</span><span class="o">(</span><span class="n">mainClass</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">mainClass</span><span class="o">.</span><span class="n">getConstructor</span><span class="o">().</span><span class="n">newInstance</span><span class="o">().</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">SparkApplication</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">new</span> <span class="nc">JavaMainApplication</span><span class="o">(</span><span class="n">mainClass</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">app</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="n">childArgs</span><span class="o">.</span><span class="n">toArray</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个方法中，我们可以看到做了这样几件事：</p>
<ul>
<li>获取class loader</li>
<li>获取mainClass并进行初始化</li>
<li>调用实例的start方法
我们这里需要关注的点是实例化了那个类，也就是childMainClass是什么，看一下<code>prepareSubmitEnvironment</code>方法</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">private</span><span class="o">[</span><span class="kt">deploy</span><span class="o">]</span> <span class="k">def</span> <span class="n">prepareSubmitEnvironment</span><span class="o">(</span>  
</span></span><span class="line"><span class="cl"><span class="n">args</span><span class="k">:</span> <span class="kt">SparkSubmitArguments</span><span class="o">,</span>  
</span></span><span class="line"><span class="cl"><span class="n">conf</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">HadoopConfiguration</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">:</span> <span class="o">(</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="nc">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="nc">SparkConf</span><span class="o">,</span> <span class="nc">String</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">(</span><span class="n">deployMode</span> <span class="o">==</span> <span class="nc">CLIENT</span><span class="o">)</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="n">childMainClass</span> <span class="k">=</span> <span class="n">args</span><span class="o">.</span><span class="n">mainClass</span> 
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">(</span><span class="n">isYarnCluster</span><span class="o">)</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="n">childMainClass</span> <span class="k">=</span> <span class="nc">YARN_CLUSTER_SUBMIT_CLASS</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Load any properties specified through --conf and the default properties file  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="o">((</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">args</span><span class="o">.</span><span class="n">sparkProperties</span><span class="o">)</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="n">sparkConf</span><span class="o">.</span><span class="n">setIfMissing</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">	<span class="o">}</span>  
</span></span><span class="line"><span class="cl">	<span class="c1">// Ignore invalid spark.driver.host in cluster modes.  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="o">(</span><span class="n">deployMode</span> <span class="o">==</span> <span class="nc">CLUSTER</span><span class="o">)</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="n">sparkConf</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="nc">DRIVER_HOST_ADDRESS</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个方法比较复杂，我只摘出来了与这次分析相关或比较重要的几句代码。
首先，如果我们使用的是client模式来提交任务，这里的childMainClass就是我们参数中的class，也就是<code>JavaWordCount</code>的全类名。
如果我们使用的是Yarn Cluster模式，这里的childMainClass则为<code>org.apache.spark.deploy.yarn.YarnClusterApplication</code>.
后续还会将我们参数中的spark配置读取并进行配置。</p>
<p>再回到<code>runMain</code>这个方法中，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">def</span> <span class="n">runMain</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">SparkSubmitArguments</span><span class="o">,</span> <span class="n">uninitLog</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="o">(</span><span class="n">childArgs</span><span class="o">,</span> <span class="n">childClasspath</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">,</span> <span class="n">childMainClass</span><span class="o">)</span> <span class="k">=</span> <span class="n">prepareSubmitEnvironment</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">loader</span> <span class="k">=</span> <span class="n">getSubmitClassLoader</span><span class="o">(</span><span class="n">sparkConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="o">(</span><span class="n">jar</span> <span class="k">&lt;-</span> <span class="n">childClasspath</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">addJarToClasspath</span><span class="o">(</span><span class="n">jar</span><span class="o">,</span> <span class="n">loader</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">mainClass</span><span class="k">:</span> <span class="kt">Class</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">mainClass</span> <span class="k">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="n">classForName</span><span class="o">(</span><span class="n">childMainClass</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">app</span><span class="k">:</span> <span class="kt">SparkApplication</span> <span class="o">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SparkApplication</span><span class="o">].</span><span class="n">isAssignableFrom</span><span class="o">(</span><span class="n">mainClass</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">mainClass</span><span class="o">.</span><span class="n">getConstructor</span><span class="o">().</span><span class="n">newInstance</span><span class="o">().</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">SparkApplication</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">new</span> <span class="nc">JavaMainApplication</span><span class="o">(</span><span class="n">mainClass</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">app</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="n">childArgs</span><span class="o">.</span><span class="n">toArray</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先来分析Client模式，这里得到的childMainClass为我们提交的任务类，在我们的例子中为<code>JavaWordCount</code>. 这个在初始化时会使用<code>JavaMainApplication</code>做一下封装。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">private</span><span class="o">[</span><span class="kt">deploy</span><span class="o">]</span> <span class="k">class</span> <span class="nc">JavaMainApplication</span><span class="o">(</span><span class="n">klass</span><span class="k">:</span> <span class="kt">Class</span><span class="o">[</span><span class="k">_</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">SparkApplication</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">override</span> <span class="k">def</span> <span class="n">start</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">conf</span><span class="k">:</span> <span class="kt">SparkConf</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">mainMethod</span> <span class="k">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">getMethod</span><span class="o">(</span><span class="s">&#34;main&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="mi">0</span><span class="o">).</span><span class="n">getClass</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(!</span><span class="nc">Modifier</span><span class="o">.</span><span class="n">isStatic</span><span class="o">(</span><span class="n">mainMethod</span><span class="o">.</span><span class="n">getModifiers</span><span class="o">))</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">&#34;The main method in the given main class must be static&#34;</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">sysProps</span> <span class="k">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getAll</span><span class="o">.</span><span class="n">toMap</span>  
</span></span><span class="line"><span class="cl"><span class="n">sysProps</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="n">k</span><span class="o">)</span> <span class="k">=</span> <span class="n">v</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">mainMethod</span><span class="o">.</span><span class="n">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当我们调用<code>app.start</code>时，其实就是调用了<code>JavaWordCount</code>这个类的main方法。
可以看到在Client模式下，直接在本地启动了我们的程序，也就是Driver是在本地进行启动。</p>
<p>再来分析一下Cluster模式下的启动，<code>childMainClass</code>得到的值是<code>YarnClusterApplication</code>.</p>
<h2 id="yarnclusterapplication">YarnClusterApplication</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">private</span><span class="o">[</span><span class="kt">spark</span><span class="o">]</span> <span class="k">class</span> <span class="nc">YarnClusterApplication</span> <span class="k">extends</span> <span class="nc">SparkApplication</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">	<span class="k">override</span> <span class="k">def</span> <span class="n">start</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">conf</span><span class="k">:</span> <span class="kt">SparkConf</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">		<span class="c1">// SparkSubmit would use yarn cache to distribute files &amp; jars in yarn mode,  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// so remove them from sparkConf here for yarn mode.  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">conf</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="nc">JARS</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">		<span class="n">conf</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="nc">FILES</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">		<span class="n">conf</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="nc">ARCHIVES</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="nc">Client</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClientArguments</span><span class="o">(</span><span class="n">args</span><span class="o">),</span> <span class="n">conf</span><span class="o">,</span> <span class="kc">null</span><span class="o">).</span><span class="n">run</span><span class="o">()</span>  
</span></span><span class="line"><span class="cl">	<span class="o">}</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于<code>YarnClusterApplication</code>是<code>SparkApplication</code>的子类，所以会直接构建实例，然后调用start方法。 在<code>YarnClusterApplication</code>的start方法中，我们看到是初始化了<code>Client</code>然后调用run方法，接下来我们看下<code>Client</code>的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">submitApplication</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="n">submitApplication</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="nc">ResourceRequestHelper</span><span class="o">.</span><span class="n">validateResources</span><span class="o">(</span><span class="n">sparkConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">launcherBackend</span><span class="o">.</span><span class="n">connect</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">yarnClient</span><span class="o">.</span><span class="n">init</span><span class="o">(</span><span class="n">hadoopConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">yarnClient</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Get a new application from our RM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">val</span> <span class="n">newApp</span> <span class="k">=</span> <span class="n">yarnClient</span><span class="o">.</span><span class="n">createApplication</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">newAppResponse</span> <span class="k">=</span> <span class="n">newApp</span><span class="o">.</span><span class="n">getNewApplicationResponse</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="n">appId</span> <span class="k">=</span> <span class="n">newAppResponse</span><span class="o">.</span><span class="n">getApplicationId</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// The app staging dir based on the STAGING_DIR configuration if configured
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// otherwise based on the users home directory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// scalastyle:off FileSystemGet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">val</span> <span class="n">appStagingBaseDir</span> <span class="k">=</span> <span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">STAGING_DIR</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">getCurrentUser</span><span class="o">.</span><span class="n">getShortUserName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">}.</span><span class="n">getOrElse</span><span class="o">(</span><span class="nc">FileSystem</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">hadoopConf</span><span class="o">).</span><span class="n">getHomeDirectory</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">		<span class="n">stagingDirPath</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="n">appStagingBaseDir</span><span class="o">,</span> <span class="n">getAppStagingDir</span><span class="o">(</span><span class="n">appId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// scalastyle:on FileSystemGet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">new</span> <span class="nc">CallerContext</span><span class="o">(</span><span class="s">&#34;CLIENT&#34;</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">APP_CALLER_CONTEXT</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">		<span class="nc">Option</span><span class="o">(</span><span class="n">appId</span><span class="o">.</span><span class="n">toString</span><span class="o">)).</span><span class="n">setCurrentContext</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="c1">// Verify whether the cluster has enough resources for our AM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">verifyClusterResources</span><span class="o">(</span><span class="n">newAppResponse</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Set up the appropriate contexts to launch our AM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">val</span> <span class="n">containerContext</span> <span class="k">=</span> <span class="n">createContainerLaunchContext</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">appContext</span> <span class="k">=</span> <span class="n">createApplicationSubmissionContext</span><span class="o">(</span><span class="n">newApp</span><span class="o">,</span> <span class="n">containerContext</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Finally, submit and monitor the application
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">logInfo</span><span class="o">(</span><span class="s">s&#34;Submitting application </span><span class="si">$appId</span><span class="s"> to ResourceManager&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 提交application
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">yarnClient</span><span class="o">.</span><span class="n">submitApplication</span><span class="o">(</span><span class="n">appContext</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">launcherBackend</span><span class="o">.</span><span class="n">setAppId</span><span class="o">(</span><span class="n">appId</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">reportLauncherState</span><span class="o">(</span><span class="nc">SparkAppHandle</span><span class="o">.</span><span class="nc">State</span><span class="o">.</span><span class="nc">SUBMITTED</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Throwable</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">stagingDirPath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">cleanupStagingDir</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">throw</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析这一段代码后我们可以知道，这里做的事情就是向Yarn集群申请启动了一个Application，也就是Application Master。在spark里就是Driver。
我们看一下这个app的具体信息，<code>createContainerLaunchContext</code>这个方法里面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">def</span> <span class="n">createContainerLaunchContext</span><span class="o">()</span><span class="k">:</span> <span class="kt">ContainerLaunchContext</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logInfo</span><span class="o">(</span><span class="s">&#34;Setting up container launch context for our AM&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">launchEnv</span> <span class="k">=</span> <span class="n">setupLaunchEnv</span><span class="o">(</span><span class="n">stagingDirPath</span><span class="o">,</span> <span class="n">pySparkArchives</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">localResources</span> <span class="k">=</span> <span class="n">prepareLocalResources</span><span class="o">(</span><span class="n">stagingDirPath</span><span class="o">,</span> <span class="n">pySparkArchives</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">amContainer</span> <span class="k">=</span> <span class="nc">Records</span><span class="o">.</span><span class="n">newRecord</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">ContainerLaunchContext</span><span class="o">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">amContainer</span><span class="o">.</span><span class="n">setLocalResources</span><span class="o">(</span><span class="n">localResources</span><span class="o">.</span><span class="n">asJava</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">amContainer</span><span class="o">.</span><span class="n">setEnvironment</span><span class="o">(</span><span class="n">launchEnv</span><span class="o">.</span><span class="n">asJava</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">javaOpts</span> <span class="k">=</span> <span class="nc">ListBuffer</span><span class="o">[</span><span class="kt">String</span><span class="o">]()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">javaOpts</span> <span class="o">+=</span> <span class="s">s&#34;-Djava.net.preferIPv6Addresses=</span><span class="si">${</span><span class="nc">Utils</span><span class="o">.</span><span class="n">preferIPv6</span><span class="si">}</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SPARK-37106: To start AM with Java 17, `JavaModuleOptions.defaultModuleOptions`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// is added by default. It will not affect Java 8 and Java 11 due to existence of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// `-XX:+IgnoreUnrecognizedVMOptions`.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">javaOpts</span> <span class="o">+=</span> <span class="nc">JavaModuleOptions</span><span class="o">.</span><span class="n">defaultModuleOptions</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Set the environment variable through a command prefix
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// to append to the existing value of the variable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">var</span> <span class="n">prefixEnv</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Add Xmx for AM memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">javaOpts</span> <span class="o">+=</span> <span class="s">&#34;-Xmx&#34;</span> <span class="o">+</span> <span class="n">amMemory</span> <span class="o">+</span> <span class="s">&#34;m&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">tmpDir</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="nc">Environment</span><span class="o">.</span><span class="nc">PWD</span><span class="o">.</span><span class="n">$$</span><span class="o">(),</span> <span class="nc">YarnConfiguration</span><span class="o">.</span><span class="nc">DEFAULT_CONTAINER_TEMP_DIR</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">javaOpts</span> <span class="o">+=</span> <span class="s">&#34;-Djava.io.tmpdir=&#34;</span> <span class="o">+</span> <span class="n">tmpDir</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Include driver-specific java options if we are launching a driver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">isClusterMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">DRIVER_JAVA_OPTIONS</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">opts</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">javaOpts</span> <span class="o">++=</span> <span class="nc">Utils</span><span class="o">.</span><span class="n">splitCommandString</span><span class="o">(</span><span class="n">opts</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">Utils</span><span class="o">.</span><span class="n">substituteAppId</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="n">appId</span><span class="o">.</span><span class="n">toString</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">YarnSparkHadoopUtil</span><span class="o">.</span><span class="n">escapeForShell</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">libraryPaths</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">DRIVER_LIBRARY_PATH</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&#34;spark.driver.libraryPath&#34;</span><span class="o">)).</span><span class="n">flatten</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">libraryPaths</span><span class="o">.</span><span class="n">nonEmpty</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">prefixEnv</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">createLibraryPathPrefix</span><span class="o">(</span><span class="n">libraryPaths</span><span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="nc">File</span><span class="o">.</span><span class="n">pathSeparator</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sparkConf</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">AM_JAVA_OPTIONS</span><span class="o">).</span><span class="n">isDefined</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logWarning</span><span class="o">(</span><span class="s">s&#34;</span><span class="si">${</span><span class="nc">AM_JAVA_OPTIONS</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s"> will not take effect in cluster mode&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Validate and include yarn am specific java options in yarn-client mode.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">AM_JAVA_OPTIONS</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">opts</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">opts</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="s">&#34;-Dspark&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="s">s&#34;</span><span class="si">${</span><span class="nc">AM_JAVA_OPTIONS</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s"> is not allowed to set Spark options (was &#39;</span><span class="si">$opts</span><span class="s">&#39;).&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">throw</span> <span class="k">new</span> <span class="nc">SparkException</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">opts</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="s">&#34;-Xmx&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="s">s&#34;</span><span class="si">${</span><span class="nc">AM_JAVA_OPTIONS</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s"> is not allowed to specify max heap memory settings &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">s&#34;(was &#39;</span><span class="si">$opts</span><span class="s">&#39;). Use spark.yarn.am.memory instead.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">throw</span> <span class="k">new</span> <span class="nc">SparkException</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">javaOpts</span> <span class="o">++=</span> <span class="nc">Utils</span><span class="o">.</span><span class="n">splitCommandString</span><span class="o">(</span><span class="n">opts</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">Utils</span><span class="o">.</span><span class="n">substituteAppId</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="n">appId</span><span class="o">.</span><span class="n">toString</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">YarnSparkHadoopUtil</span><span class="o">.</span><span class="n">escapeForShell</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">AM_LIBRARY_PATH</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">paths</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">prefixEnv</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">createLibraryPathPrefix</span><span class="o">(</span><span class="n">paths</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// For log4j2 configuration to reference
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">javaOpts</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&#34;-Dspark.yarn.app.container.log.dir=&#34;</span> <span class="o">+</span> <span class="nc">ApplicationConstants</span><span class="o">.</span><span class="nc">LOG_DIR_EXPANSION_VAR</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">userClass</span> <span class="k">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">isClusterMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;--class&#34;</span><span class="o">,</span> <span class="nc">YarnSparkHadoopUtil</span><span class="o">.</span><span class="n">escapeForShell</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">userClass</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">userJar</span> <span class="k">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">userJar</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;--jar&#34;</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="n">userJar</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">primaryPyFile</span> <span class="k">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">isClusterMode</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">.</span><span class="n">primaryPyFile</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;--primary-py-file&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryPyFile</span><span class="o">).</span><span class="n">getName</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">primaryRFile</span> <span class="k">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;--primary-r-file&#34;</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">amClass</span> <span class="k">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">isClusterMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Utils</span><span class="o">.</span><span class="n">classForName</span><span class="o">(</span><span class="s">&#34;org.apache.spark.deploy.yarn.ApplicationMaster&#34;</span><span class="o">).</span><span class="n">getName</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Utils</span><span class="o">.</span><span class="n">classForName</span><span class="o">(</span><span class="s">&#34;org.apache.spark.deploy.yarn.ExecutorLauncher&#34;</span><span class="o">).</span><span class="n">getName</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="s">&#34;.R&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="s">&#34;.r&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">args</span><span class="o">.</span><span class="n">userArgs</span> <span class="k">=</span> <span class="nc">ArrayBuffer</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span><span class="o">)</span> <span class="o">++</span> <span class="n">args</span><span class="o">.</span><span class="n">userArgs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">userArgs</span> <span class="k">=</span> <span class="n">args</span><span class="o">.</span><span class="n">userArgs</span><span class="o">.</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">arg</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;--arg&#34;</span><span class="o">,</span> <span class="nc">YarnSparkHadoopUtil</span><span class="o">.</span><span class="n">escapeForShell</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">amArgs</span> <span class="k">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="n">amClass</span><span class="o">)</span> <span class="o">++</span> <span class="n">userClass</span> <span class="o">++</span> <span class="n">userJar</span> <span class="o">++</span> <span class="n">primaryPyFile</span> <span class="o">++</span> <span class="n">primaryRFile</span> <span class="o">++</span> <span class="n">userArgs</span> <span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;--properties-file&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">buildPath</span><span class="o">(</span><span class="nc">Environment</span><span class="o">.</span><span class="nc">PWD</span><span class="o">.</span><span class="n">$$</span><span class="o">(),</span> <span class="nc">LOCALIZED_CONF_DIR</span><span class="o">,</span> <span class="nc">SPARK_CONF_FILE</span><span class="o">))</span> <span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;--dist-cache-conf&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">buildPath</span><span class="o">(</span><span class="nc">Environment</span><span class="o">.</span><span class="nc">PWD</span><span class="o">.</span><span class="n">$$</span><span class="o">(),</span> <span class="nc">LOCALIZED_CONF_DIR</span><span class="o">,</span> <span class="nc">DIST_CACHE_CONF_FILE</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Command for the ApplicationMaster
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">commands</span> <span class="k">=</span> <span class="n">prefixEnv</span> <span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span><span class="nc">Environment</span><span class="o">.</span><span class="nc">JAVA_HOME</span><span class="o">.</span><span class="n">$$</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;/bin/java&#34;</span><span class="o">,</span> <span class="s">&#34;-server&#34;</span><span class="o">)</span> <span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">javaOpts</span> <span class="o">++</span> <span class="n">amArgs</span> <span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Seq</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&gt;&#34;</span><span class="o">,</span> <span class="nc">ApplicationConstants</span><span class="o">.</span><span class="nc">LOG_DIR_EXPANSION_VAR</span> <span class="o">+</span> <span class="s">&#34;/stdout&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;2&gt;&#34;</span><span class="o">,</span> <span class="nc">ApplicationConstants</span><span class="o">.</span><span class="nc">LOG_DIR_EXPANSION_VAR</span> <span class="o">+</span> <span class="s">&#34;/stderr&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// TODO: it would be nicer to just make sure there are no null commands here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">printableCommands</span> <span class="k">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="s">&#34;null&#34;</span> <span class="k">else</span> <span class="n">s</span><span class="o">).</span><span class="n">toList</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">amContainer</span><span class="o">.</span><span class="n">setCommands</span><span class="o">(</span><span class="n">printableCommands</span><span class="o">.</span><span class="n">asJava</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// send the acl settings into YARN to control who has access via YARN interfaces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">securityManager</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SecurityManager</span><span class="o">(</span><span class="n">sparkConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">amContainer</span><span class="o">.</span><span class="n">setApplicationACLs</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">YarnSparkHadoopUtil</span><span class="o">.</span><span class="n">getApplicationAclsForYarn</span><span class="o">(</span><span class="n">securityManager</span><span class="o">).</span><span class="n">asJava</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">setupSecurityToken</span><span class="o">(</span><span class="n">amContainer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">setTokenConf</span><span class="o">(</span><span class="n">amContainer</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">amContainer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们看一下这段代码，他其实也是在构建启动的命令。我们重点关注下这几句代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">userClass</span> <span class="k">=</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">isClusterMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;--class&#34;</span><span class="o">,</span> <span class="nc">YarnSparkHadoopUtil</span><span class="o">.</span><span class="n">escapeForShell</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">userClass</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="nc">Nil</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">amClass</span> <span class="k">=</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">isClusterMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="nc">Utils</span><span class="o">.</span><span class="n">classForName</span><span class="o">(</span><span class="s">&#34;org.apache.spark.deploy.yarn.ApplicationMaster&#34;</span><span class="o">).</span><span class="n">getName</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="nc">Utils</span><span class="o">.</span><span class="n">classForName</span><span class="o">(</span><span class="s">&#34;org.apache.spark.deploy.yarn.ExecutorLauncher&#34;</span><span class="o">).</span><span class="n">getName</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>userClass 用户真实要启动的类，在cluster模式下，从参数中解析。
amClass 启动类，在cluster模式下，为<code>ApplicationMaster</code>. 在我们的这个例子中，就会在Yarn中启动一个Application，启动类为<code>ApplicationMaster</code>. 接下来我们要看<code>ApplicationMaster</code>这个类的代码。
还有一点要注意一下，以上所有的代码都是在本地执行的，也就是在执行submit-shell脚本的这个机器上执行的。后续的操作都是在Yarn集群上执行的</p>
<h2 id="applicationmaster">ApplicationMaster</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="nc">SignalUtils</span><span class="o">.</span><span class="n">registerLogger</span><span class="o">(</span><span class="n">log</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">amArgs</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ApplicationMasterArguments</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">sparkConf</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkConf</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">(</span><span class="n">amArgs</span><span class="o">.</span><span class="n">propertiesFile</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="nc">Utils</span><span class="o">.</span><span class="n">getPropertiesFromFile</span><span class="o">(</span><span class="n">amArgs</span><span class="o">.</span><span class="n">propertiesFile</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="n">sparkConf</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Both cases create a new SparkConf object which reads these configs from system properties.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sparkConf</span><span class="o">.</span><span class="n">getAll</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="n">sys</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="n">k</span><span class="o">)</span> <span class="k">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">yarnConf</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">YarnConfiguration</span><span class="o">(</span><span class="nc">SparkHadoopUtil</span><span class="o">.</span><span class="n">newConfiguration</span><span class="o">(</span><span class="n">sparkConf</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">master</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ApplicationMaster</span><span class="o">(</span><span class="n">amArgs</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">,</span> <span class="n">yarnConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">val</span> <span class="n">ugi</span> <span class="k">=</span> <span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">PRINCIPAL</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">principal</span><span class="o">)</span> <span class="k">if</span> <span class="n">master</span><span class="o">.</span><span class="n">isClusterMode</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">originalCreds</span> <span class="k">=</span> <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">getCurrentUser</span><span class="o">().</span><span class="n">getCredentials</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="nc">SparkHadoopUtil</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">loginUserFromKeytab</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">KEYTAB</span><span class="o">).</span><span class="n">orNull</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">newUGI</span> <span class="k">=</span> <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">getCurrentUser</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">master</span><span class="o">.</span><span class="n">appAttemptId</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">master</span><span class="o">.</span><span class="n">appAttemptId</span><span class="o">.</span><span class="n">getAttemptId</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="nc">Utils</span><span class="o">.</span><span class="n">withContextClassLoader</span><span class="o">(</span><span class="n">master</span><span class="o">.</span><span class="n">userClassLoader</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">val</span> <span class="n">credentialManager</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HadoopDelegationTokenManager</span><span class="o">(</span><span class="n">sparkConf</span><span class="o">,</span> <span class="n">yarnConf</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">credentialManager</span><span class="o">.</span><span class="n">obtainDelegationTokens</span><span class="o">(</span><span class="n">originalCreds</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">newUGI</span><span class="o">.</span><span class="n">addCredentials</span><span class="o">(</span><span class="n">originalCreds</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">newUGI</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="nc">SparkHadoopUtil</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">createSparkUser</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ugi</span><span class="o">.</span><span class="n">doAs</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedExceptionAction</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">exit</span><span class="o">(</span><span class="n">master</span><span class="o">.</span><span class="n">run</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">	<span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码的主要逻辑为构建<code>ApplicationMaster</code>并调用其<code>run</code>方法。根据其返回值做响应。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">final</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">attemptID</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">isClusterMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="nc">None</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="nc">CallerContext</span><span class="o">(</span><span class="s">&#34;APPMASTER&#34;</span><span class="o">,</span> <span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">APP_CALLER_CONTEXT</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">			<span class="nc">Option</span><span class="o">(</span><span class="n">appAttemptId</span><span class="o">.</span><span class="n">getApplicationId</span><span class="o">.</span><span class="n">toString</span><span class="o">),</span> <span class="n">attemptID</span><span class="o">).</span><span class="n">setCurrentContext</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">logInfo</span><span class="o">(</span><span class="s">&#34;ApplicationAttemptId: &#34;</span> <span class="o">+</span> <span class="n">appAttemptId</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">stagingDirPath</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">getenv</span><span class="o">(</span><span class="s">&#34;SPARK_YARN_STAGING_DIR&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">stagingDirFs</span> <span class="k">=</span> <span class="n">stagingDirPath</span><span class="o">.</span><span class="n">getFileSystem</span><span class="o">(</span><span class="n">yarnConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">val</span> <span class="n">priority</span> <span class="k">=</span> <span class="nc">ShutdownHookManager</span><span class="o">.</span><span class="nc">SPARK_CONTEXT_SHUTDOWN_PRIORITY</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="nc">ShutdownHookManager</span><span class="o">.</span><span class="n">addShutdownHook</span><span class="o">(</span><span class="n">priority</span><span class="o">)</span> <span class="o">{</span> <span class="o">()</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">			<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">isClusterMode</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">runDriver</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">runExecutorLauncher</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="n">logError</span><span class="o">(</span><span class="s">&#34;Uncaught exception: &#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">finish</span><span class="o">(</span><span class="nc">FinalApplicationStatus</span><span class="o">.</span><span class="nc">FAILEDApplicationMaster</span><span class="o">.</span><span class="nc">EXIT_UNCAUGHT_EXCEPTION</span><span class="o">,</span><span class="s">&#34;Uncaught exception: &#34;</span> <span class="o">+</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="n">stringifyException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">metricsSystem</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">ms</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">				<span class="n">ms</span><span class="o">.</span><span class="n">report</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">				<span class="n">ms</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="n">logWarning</span><span class="o">(</span><span class="s">&#34;Exception during stopping of the metric system: &#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">exitCode</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span> <span class="k">def</span> <span class="n">runDriver</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addAmIpFilter</span><span class="o">(</span><span class="nc">None</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="n">getenv</span><span class="o">(</span><span class="nc">ApplicationConstants</span><span class="o">.</span><span class="nc">APPLICATION_WEB_PROXY_BASE_ENV</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">userClassThread</span> <span class="k">=</span> <span class="n">startUserApplication</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// This a bit hacky, but we need to wait until the spark.driver.port property has
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// been set by the Thread executing the user class.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">logInfo</span><span class="o">(</span><span class="s">&#34;Waiting for spark context initialization...&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">totalWaitTime</span> <span class="k">=</span> <span class="n">sparkConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">AM_MAX_WAIT_TIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">sc</span> <span class="k">=</span> <span class="nc">ThreadUtils</span><span class="o">.</span><span class="n">awaitResult</span><span class="o">(</span><span class="n">sparkContextPromise</span><span class="o">.</span><span class="n">future</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Duration</span><span class="o">(</span><span class="n">totalWaitTime</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">MILLISECONDS</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">rpcEnv</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">rpcEnv</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">userConf</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getConf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">host</span> <span class="k">=</span> <span class="n">userConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">DRIVER_HOST_ADDRESS</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">port</span> <span class="k">=</span> <span class="n">userConf</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="nc">DRIVER_PORT</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">registerAM</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">userConf</span><span class="o">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">webUrl</span><span class="o">),</span> <span class="n">appAttemptId</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">driverRef</span> <span class="k">=</span> <span class="n">rpcEnv</span><span class="o">.</span><span class="n">setupEndpointRef</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">RpcAddress</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">YarnSchedulerBackend</span><span class="o">.</span><span class="nc">ENDPOINT_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">createAllocator</span><span class="o">(</span><span class="n">driverRef</span><span class="o">,</span> <span class="n">userConf</span><span class="o">,</span> <span class="n">rpcEnv</span><span class="o">,</span> <span class="n">appAttemptId</span><span class="o">,</span> <span class="n">distCacheConf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Sanity check; should never happen in normal operation, since sc should only be null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// if the user app did not create a SparkContext.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">&#34;User did not initialize spark context!&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resumeDriver</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">userClassThread</span><span class="o">.</span><span class="n">join</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">SparkException</span> <span class="kt">if</span> <span class="kt">e.getCause</span><span class="o">()</span><span class="kt">.isInstanceOf</span><span class="o">[</span><span class="kt">TimeoutException</span><span class="o">]</span> <span class="k">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logError</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">s&#34;SparkContext did not initialize after waiting for </span><span class="si">$totalWaitTime</span><span class="s"> ms. &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;Please check earlier log output for errors. Failing the application.&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">finish</span><span class="o">(</span><span class="nc">FinalApplicationStatus</span><span class="o">.</span><span class="nc">FAILED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">ApplicationMaster</span><span class="o">.</span><span class="nc">EXIT_SC_NOT_INITED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;Timed out waiting for SparkContext.&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resumeDriver</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span> <span class="k">def</span> <span class="n">startUserApplication</span><span class="o">()</span><span class="k">:</span> <span class="kt">Thread</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="n">logInfo</span><span class="o">(</span><span class="s">&#34;Starting the user application in a separate Thread&#34;</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">var</span> <span class="n">userArgs</span> <span class="k">=</span> <span class="n">args</span><span class="o">.</span><span class="n">userArgs</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryPyFile</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">.</span><span class="n">primaryPyFile</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="s">&#34;.py&#34;</span><span class="o">))</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// When running pyspark, the app is run using PythonRunner. The second argument is the list  
</span></span></span><span class="line"><span class="cl"><span class="c1">// of files to add to PYTHONPATH, which Client.scala already handles, so it&#39;s empty.  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">userArgs</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryPyFile</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">)</span> <span class="o">++</span> <span class="n">userArgs</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>  
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="s">&#34;.R&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="n">args</span><span class="o">.</span><span class="n">primaryRFile</span><span class="o">.</span><span class="n">endsWith</span><span class="o">(</span><span class="s">&#34;.r&#34;</span><span class="o">)))</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// TODO(davies): add R dependencies here  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">mainMethod</span> <span class="k">=</span> <span class="n">userClassLoader</span><span class="o">.</span><span class="n">loadClass</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">userClass</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">getMethod</span><span class="o">(</span><span class="s">&#34;main&#34;</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">userThread</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Thread</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(!</span><span class="nc">Modifier</span><span class="o">.</span><span class="n">isStatic</span><span class="o">(</span><span class="n">mainMethod</span><span class="o">.</span><span class="n">getModifiers</span><span class="o">))</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="n">logError</span><span class="o">(</span><span class="s">s&#34;Could not find static main method in object </span><span class="si">${</span><span class="n">args</span><span class="o">.</span><span class="n">userClass</span><span class="si">}</span><span class="s">&#34;</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">finish</span><span class="o">(</span><span class="nc">FinalApplicationStatus</span><span class="o">.</span><span class="nc">FAILED</span><span class="o">,</span> <span class="nc">ApplicationMaster</span><span class="o">.</span><span class="nc">EXIT_EXCEPTION_USER_CLASS</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="n">mainMethod</span><span class="o">.</span><span class="n">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">userArgs</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">finish</span><span class="o">(</span><span class="nc">FinalApplicationStatus</span><span class="o">.</span><span class="nc">SUCCEEDED</span><span class="o">,</span> <span class="nc">ApplicationMaster</span><span class="o">.</span><span class="nc">EXIT_SUCCESS</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">logDebug</span><span class="o">(</span><span class="s">&#34;Done running user class&#34;</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">InvocationTargetException</span> <span class="o">=&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="n">e</span><span class="o">.</span><span class="n">getCause</span> <span class="k">match</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="k">_:</span> <span class="kt">InterruptedException</span> <span class="o">=&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// Reporter thread can interrupt to stop user class  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">case</span> <span class="nc">SparkUserAppException</span><span class="o">(</span><span class="n">exitCode</span><span class="o">)</span> <span class="k">=&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="s">s&#34;User application exited with status </span><span class="si">$exitCode</span><span class="s">&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="n">logError</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">finish</span><span class="o">(</span><span class="nc">FinalApplicationStatus</span><span class="o">.</span><span class="nc">FAILED</span><span class="o">,</span> <span class="n">exitCode</span><span class="o">,</span> <span class="n">msg</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="n">cause</span><span class="k">:</span> <span class="kt">Throwable</span> <span class="o">=&gt;</span>  
</span></span><span class="line"><span class="cl"><span class="n">logError</span><span class="o">(</span><span class="s">&#34;User class threw exception: &#34;</span><span class="o">,</span> <span class="n">cause</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">finish</span><span class="o">(</span><span class="nc">FinalApplicationStatus</span><span class="o">.</span><span class="nc">FAILED</span><span class="o">,</span>  
</span></span><span class="line"><span class="cl"><span class="nc">ApplicationMaster</span><span class="o">.</span><span class="nc">EXIT_EXCEPTION_USER_CLASS</span><span class="o">,</span>  
</span></span><span class="line"><span class="cl"><span class="s">&#34;User class threw exception: &#34;</span> <span class="o">+</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="n">stringifyException</span><span class="o">(</span><span class="n">cause</span><span class="o">))</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl"><span class="n">sparkContextPromise</span><span class="o">.</span><span class="n">tryFailure</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">getCause</span><span class="o">())</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// Notify the thread waiting for the SparkContext, in case the application did not  
</span></span></span><span class="line"><span class="cl"><span class="c1">// instantiate one. This will do nothing when the user code instantiates a SparkContext  
</span></span></span><span class="line"><span class="cl"><span class="c1">// (with the correct master), or when the user code throws an exception (due to the  
</span></span></span><span class="line"><span class="cl"><span class="c1">// tryFailure above).  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">sparkContextPromise</span><span class="o">.</span><span class="n">trySuccess</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span><span class="line"><span class="cl"><span class="n">userThread</span><span class="o">.</span><span class="n">setContextClassLoader</span><span class="o">(</span><span class="n">userClassLoader</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">userThread</span><span class="o">.</span><span class="n">setName</span><span class="o">(</span><span class="s">&#34;Driver&#34;</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">userThread</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>  
</span></span><span class="line"><span class="cl"><span class="n">userThread</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>ApplicationMaster</code>的<code>run</code>方法中，我们可以看到它做了这样几件事：构建上下文，添加钩子函数， 在我们这个例子中调用<code>runDriver</code>方法。
在<code>runDriver</code>方法中，我们可以看到上面就会调用<code>startUserApplication</code>这个方法，从这个函数名称我们也可以看到，这里才真正调用到了用户程序，使用反射调用到了用户的程序，在用户的程序中会做SparkContext的初始化，如果用户的主程序没有做SparkContext的初始化，在<code>runDriver</code>中也会进行检测，从而抛出异常。用户程序是新启动一个线程来运行，主程序会等待用户程序结束。</p>
<h2 id="javawordcount">JavaWordCount</h2>
<p>我们再来看下我们的这个example程序。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Usage: JavaWordCount &lt;file&gt;&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">System</span><span class="p">.</span><span class="na">exit</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">SparkSession</span><span class="w"> </span><span class="n">spark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SparkSession</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">.</span><span class="na">appName</span><span class="p">(</span><span class="s">&#34;JavaWordCount&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">.</span><span class="na">getOrCreate</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">JavaRDD</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">read</span><span class="p">().</span><span class="na">textFile</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">).</span><span class="na">javaRDD</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">JavaRDD</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lines</span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">SPACE</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">s</span><span class="p">)).</span><span class="na">iterator</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">JavaPairRDD</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ones</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">words</span><span class="p">.</span><span class="na">mapToPair</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tuple2</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">JavaPairRDD</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">.</span><span class="na">reduceByKey</span><span class="p">((</span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">i2</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i2</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">collect</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Tuple2</span><span class="o">&lt;?</span><span class="p">,</span><span class="o">?&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">tuple</span><span class="p">.</span><span class="na">_1</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tuple</span><span class="p">.</span><span class="na">_2</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">spark</span><span class="p">.</span><span class="na">stop</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在这里初始化了SparkSession，然后从文件读取，转化，然后调用<code>collect</code>算子后打印结果。
最终关闭SparkSession。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">def</span> <span class="n">collect</span><span class="o">()</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="n">withScope</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">results</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">runJob</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="o">(</span><span class="n">iter</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="n">iter</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="nc">Array</span><span class="o">.</span><span class="n">concat</span><span class="o">(</span><span class="n">results</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个例子中，是最后的collect这个action算子，最终调用了<code>runJob</code>。
到这里就完成了整个任务的部署。</p>
<p>总结一下：
当我们执行<code>spark-submit.sh</code>时，会先执行<code>SparkSubmit</code>然后根据<code>master</code>和<code>deploy-mode</code>启动不同的提交类。如果是local mode则直接启动用户的主类，否则启动不同集群模式的类。
在集群提交类中，此例中为<code>YarnClusterApplication</code>. 在这个类中做的事情是在Yarn集群上启动一个Application也就是<code>ApplicationMaster</code>，这个Application启动后会在一个新线程启动user application。user application也就是我们任务的主类。</p>
<h1 id="sparklauncher">SparkLauncher</h1>
<p>Spark还提供了一种方式，可以将提交任务集成到Java代码中。用户可以使用一个Service来集中化做任务提交，可以方便的管理集群中提交的任务数量等等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">SparkLauncher</span><span class="w"> </span><span class="n">launcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkLauncher</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">launcher</span><span class="p">.</span><span class="na">setMaster</span><span class="p">(</span><span class="err">“</span><span class="n">yarn</span><span class="err">”</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">launcher</span><span class="p">.</span><span class="na">setDeployMode</span><span class="p">(</span><span class="err">“</span><span class="n">cluster</span><span class="err">”</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">launcher</span><span class="p">.</span><span class="na">setMainClass</span><span class="p">(</span><span class="err">“</span><span class="p">...</span><span class="err">”</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">launcher</span><span class="p">.</span><span class="na">setAppResource</span><span class="p">(</span><span class="err">“</span><span class="p">...</span><span class="err">”</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">launcher</span><span class="p">.</span><span class="na">addAppArgs</span><span class="p">(</span><span class="err">“</span><span class="p">...</span><span class="err">”</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">SparkAppHandle</span><span class="p">.</span><span class="na">Listener</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkAppHandle</span><span class="p">.</span><span class="na">Listener</span><span class="p">(){...}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">launcher</span><span class="p">.</span><span class="na">startApplication</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以以一个大概这样的代码就可以提交并启动一个Spark任务。并且添加了Listener，可以对任务的状态进行感知。
我们来看一下这个的具体实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">SparkAppHandle</span><span class="w"> </span><span class="nf">startApplication</span><span class="p">(</span><span class="n">SparkAppHandle</span><span class="p">.</span><span class="na">Listener</span><span class="p">...</span><span class="w"> </span><span class="n">listeners</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">LauncherServer</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LauncherServer</span><span class="p">.</span><span class="na">getOrCreateServer</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ChildProcAppHandle</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChildProcAppHandle</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">SparkAppHandle</span><span class="p">.</span><span class="na">Listener</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">listeners</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">handle</span><span class="p">.</span><span class="na">addListener</span><span class="p">(</span><span class="n">l</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="na">registerHandle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">loggerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getLoggerName</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ProcessBuilder</span><span class="w"> </span><span class="n">pb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBuilder</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">LOG</span><span class="p">.</span><span class="na">isLoggable</span><span class="p">(</span><span class="n">Level</span><span class="p">.</span><span class="na">FINE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">LOG</span><span class="p">.</span><span class="na">fine</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;Launching Spark application:%n%s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">join</span><span class="p">(</span><span class="s">&#34; &#34;</span><span class="p">,</span><span class="w"> </span><span class="n">pb</span><span class="p">.</span><span class="na">command</span><span class="p">())));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">outputToLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputStream</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">errorToLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">redirectErrorStream</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">errorStream</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Only setup stderr + stdout to logger redirection if user has not otherwise configured output  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// redirection.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loggerName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">outputToLog</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">errorToLog</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">appName</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">appName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">appName</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">mainClass</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">dot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">mainClass</span><span class="p">.</span><span class="na">lastIndexOf</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dot</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dot</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">mainClass</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">mainClass</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">dot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">mainClass</span><span class="p">.</span><span class="na">length</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">mainClass</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">appResource</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">appResource</span><span class="p">).</span><span class="na">getName</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">COUNTER</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">loggerPrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClass</span><span class="p">().</span><span class="na">getPackage</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">loggerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;%s.app.%s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">loggerPrefix</span><span class="p">,</span><span class="w"> </span><span class="n">appName</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outputToLog</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">errorToLog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pb</span><span class="p">.</span><span class="na">redirectErrorStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pb</span><span class="p">.</span><span class="na">environment</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">LauncherProtocol</span><span class="p">.</span><span class="na">ENV_LAUNCHER_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="na">getPort</span><span class="p">()));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pb</span><span class="p">.</span><span class="na">environment</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">LauncherProtocol</span><span class="p">.</span><span class="na">ENV_LAUNCHER_SECRET</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Process</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pb</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">InputStream</span><span class="w"> </span><span class="n">logStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loggerName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">logStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputToLog</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="na">getErrorStream</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">handle</span><span class="p">.</span><span class="na">setChildProc</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">loggerName</span><span class="p">,</span><span class="w"> </span><span class="n">logStream</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ioe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">handle</span><span class="p">.</span><span class="na">kill</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">throw</span><span class="w"> </span><span class="n">ioe</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码中的主要逻辑是调用了<code>ProcessBuilder.start()</code>方法，我们先看一下这个<code>ProcessBuilder</code>创建逻辑：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">ProcessBuilder</span><span class="w"> </span><span class="nf">createBuilder</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cmd</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">findSparkSubmit</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cmd</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="na">buildSparkSubmitArgs</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Since the child process is a batch script, let&#39;s quote things so that special characters are  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// preserved, otherwise the batch interpreter will mess up the arguments. Batch scripts are  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// weird.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isWindows</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">winCmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cmd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">winCmd</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">quoteForBatchScript</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">winCmd</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ProcessBuilder</span><span class="w"> </span><span class="n">pb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProcessBuilder</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[</span><span class="n">cmd</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">childEnv</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pb</span><span class="p">.</span><span class="na">environment</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">workingDir</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pb</span><span class="p">.</span><span class="na">directory</span><span class="p">(</span><span class="n">workingDir</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Only one of redirectError and redirectError(...) can be specified.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Similarly, if redirectToLog is specified, no other redirections should be specified.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">checkState</span><span class="p">(</span><span class="o">!</span><span class="n">redirectErrorStream</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">errorStream</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="s">&#34;Cannot specify both redirectError() and redirectError(...) &#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">checkState</span><span class="p">(</span><span class="n">getLoggerName</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">((</span><span class="o">!</span><span class="n">redirectErrorStream</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">errorStream</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">outputStream</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">),</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="s">&#34;Cannot used redirectToLog() in conjunction with other redirection methods.&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">redirectErrorStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pb</span><span class="p">.</span><span class="na">redirectErrorStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errorStream</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pb</span><span class="p">.</span><span class="na">redirectError</span><span class="p">(</span><span class="n">errorStream</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outputStream</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pb</span><span class="p">.</span><span class="na">redirectOutput</span><span class="p">(</span><span class="n">outputStream</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">pb</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过这段代码可以看出它其实也是在构建一段<code>spark-submit</code>命令。
通过<code>ProcessBuilder</code>构建并运行<code>spark-submit</code>命令，然后将其作为子进程进行监控。</p>

    </article>
  </main>
  

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css"
    integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"
    integrity="sha384-YNHdsYkH6gMx9y3mRkmcJ2mFUjTd0qNQQvY9VYZgQd7DcN7env35GzlmFaZ23JGp"
    crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"
    integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl"
    crossorigin="anonymous"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            
            
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true }
            ],
            
            throwOnError: false
        });
    });
</script>





<script 
  src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"
  crossorigin="anonymous">
</script>
<script>
  mermaid.init(undefined, 'code.language-mermaid')
</script>




</div>


  <footer class="mt-8 mb-8">
  <div class="container mx-auto">
    <div class="mt-8 flex flex-col-reverse sm:flex-row sm:justify-between items-center">
      <div class="text-center sm:text-left">
        <p class="mt-0 text-sm"></p>
        <p class="mt-0 text-xs">
          Built with <a href="https://gohugo.io" target="_blank" rel="noopener noreferrer">Hugo</a> v0.143.1
          and <a href="https://github.com/mivinci/hugo-theme-minima" target="_blank" rel="noopener noreferrer">Minima</a>
        </p>
      </div>
      
      <p class="flex items-center mt-0">
        
          <a class="icon ml-1 mr-1" href="mailto:jarvis@apache.org" title="email">
          
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
          
          </a>
        
          <a class="icon ml-1 mr-1" href="https://github.com/liunaijie" title="github">
          
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
          
          </a>
        
          <a class="icon ml-1 mr-1" href="/index.xml" title="rss">
          
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
          
          </a>
        
      </p>
    </div>
  </div>
</footer>
</body>

</html>