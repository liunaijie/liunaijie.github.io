<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta property="og:url" content="https://www.liunaijie.top/publish/spark%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%BA%8Csparkcontext/">
  <meta property="og:site_name" content="Jarvis`s library">
  <meta property="og:title" content="Spark源码解析-(二)SparkContext">
  <meta property="og:description" content="继上一篇分析完Spark的提交流程之后, 这次继续分析下SparkContext的源码.
创建 当Spark通过反射调用用户提交类的主函数时, 用户的主函数内会完成SparkContext的创建. 还是以JavaWordCount为例
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public static void main(String[] args) throws Exception { ... SparkSession spark = SparkSession .builder() .appName(&#34;JavaWordCount&#34;) .getOrCreate(); JavaRDD&lt;String&gt; lines = spark.read().textFile(args[0]).javaRDD(); ... List&lt;Tuple2&lt;String, Integer&gt;&gt; output = counts.collect(); for (Tuple2&lt;?,?&gt; tuple : output) { System.out.println(tuple._1() &#43; &#34;: &#34; &#43; tuple._2()); } spark.stop(); } 在这里是手动创建了SparkSession, SparkContext由SparkSession间接完成创建.">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="publish">
    <meta property="article:published_time" content="2023-07-30T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-07-30T00:00:00+00:00">
    <meta property="article:tag" content="Spark">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Spark源码解析-(二)SparkContext">
  <meta name="twitter:description" content="继上一篇分析完Spark的提交流程之后, 这次继续分析下SparkContext的源码.
创建 当Spark通过反射调用用户提交类的主函数时, 用户的主函数内会完成SparkContext的创建. 还是以JavaWordCount为例
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public static void main(String[] args) throws Exception { ... SparkSession spark = SparkSession .builder() .appName(&#34;JavaWordCount&#34;) .getOrCreate(); JavaRDD&lt;String&gt; lines = spark.read().textFile(args[0]).javaRDD(); ... List&lt;Tuple2&lt;String, Integer&gt;&gt; output = counts.collect(); for (Tuple2&lt;?,?&gt; tuple : output) { System.out.println(tuple._1() &#43; &#34;: &#34; &#43; tuple._2()); } spark.stop(); } 在这里是手动创建了SparkSession, SparkContext由SparkSession间接完成创建.">

  
  
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#181818">
  <title>
    
    Jarvis`s library - Spark源码解析-(二)SparkContext
    
  </title>
  
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  
  
  
  <link rel="stylesheet" href="/minima.54cfcb44e10b4015b41a13771763013b79bdba6a92e49ea4a77bb44db465e761.css" integrity="sha256-VM/LROELQBW0GhN3F2MBO3m9umqS5J6kp3u0TbRl52E=">
  
  
  
  <script defer type="text/javascript" src="/minima.b4da24217e147f536fc7dc225886a1ea20bedabe7aed49e546a5d97cc34e4555.js" integrity="sha256-tNokIX4Uf1Nvx9wiWIah6iC&#43;2r567UnlRqXZfMNORVU="></script>
  
  
  
</head>
<script>
  const theme_config = 'system'
  const theme_light = theme_config === 'system' ? 'light' : theme_config;
  let theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : theme_light;
  console.debug(theme);

  try {
    localStorage.setItem('theme', theme);
    window.minima_theme = theme;
    document.querySelector('html').classList.add(theme);
  } catch (e) {
    console.error(e);
  }
</script>



<body>
  <header class="mt-3 mb-8">
  <div class="container mx-auto">
    <nav class="flex justify-between items-center">
      <div class="flex items-center">
        
        <div id="theme-switch" class="text-2xl cursor-pointer"></div>
      </div>
      <ul class="flex items-center text-base font-semibold
        whitespace-nowrap overflow-x-auto overflow-y-hidden">
        
        <li class="ml-2 mr-2">
          
          <a href='/'>首页</a>
          
        </li>
        
        <li class="ml-2 mr-2">
          
          <a href="/tags">标签</a>
          
        </li>
        
        <li class="ml-2 mr-2">
          
          <a href="/search">搜索</a>
          
        </li>
        
        <li class="ml-2 mr-2">
          
          <a href="/about">关于</a>
          
        </li>
        
      </ul>
      <ul class="flex item-center text-sm font-semibold">
        
        <li class="ml-2"><a href="https://www.liunaijie.top/"></a></li>
        
      </ul>
    </nav>
  </div>
</header>

  
<div class="container mx-auto">
  <h1 class="text-4xl font-extrabold mt-6 mb-6">Spark源码解析-(二)SparkContext</h1>
  <div class="mb-3 text-sm flex justify-between ">
    <div>
      
      发布于 &mdash; 2023 年 07 月 30 日
      
      
    </div>
    
    <div>
      
      
      <a class="ml-1" href="/tags/spark">#spark</a>
      
    </div>
    
  </div>
  <main class="mb-8">
    <p></p>
    <article class="md">
      <p>继上一篇分析完Spark的提交流程之后, 这次继续分析下SparkContext的源码.</p>
<h1 id="创建">创建</h1>
<p>当Spark通过反射调用用户提交类的主函数时, 用户的主函数内会完成SparkContext的创建.
还是以<code>JavaWordCount</code>为例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">SparkSession</span><span class="w"> </span><span class="n">spark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SparkSession</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">appName</span><span class="p">(</span><span class="s">&#34;JavaWordCount&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">getOrCreate</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">JavaRDD</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">read</span><span class="p">().</span><span class="na">textFile</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">).</span><span class="na">javaRDD</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">...</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counts</span><span class="p">.</span><span class="na">collect</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Tuple2</span><span class="o">&lt;?</span><span class="p">,</span><span class="o">?&gt;</span><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">tuple</span><span class="p">.</span><span class="na">_1</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tuple</span><span class="p">.</span><span class="na">_2</span><span class="p">());</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">spark</span><span class="p">.</span><span class="na">stop</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在这里是手动创建了SparkSession, SparkContext由SparkSession间接完成创建.</p>
<h1 id="主要代码分析">主要代码分析</h1>
<p><code>SparkContext</code>维护了<code>DAGScheduler</code>和<code>TaskScheduler</code>, 在创建<code>SparkContext</code>时会完成这两个类的创建及初始化.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">clone</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_conf</span><span class="p">.</span><span class="na">validateSettings</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_conf</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="s">&#34;spark.app.startTime&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">startTime</span><span class="p">.</span><span class="na">toString</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_listenerBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LiveListenerBus</span><span class="p">(</span><span class="n">_conf</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_resourceProfileManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ResourceProfileManager</span><span class="p">(</span><span class="n">_conf</span><span class="p">,</span><span class="w"> </span><span class="n">_listenerBus</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Initialize the app status store and listener before SparkEnv is created so that it gets  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// all events.  val appStatusSource = AppStatusSource.createSource(conf)  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_statusStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppStatusStore</span><span class="p">.</span><span class="na">createLiveStore</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">appStatusSource</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">listenerBus</span><span class="p">.</span><span class="na">addToStatusQueue</span><span class="p">(</span><span class="n">_statusStore</span><span class="p">.</span><span class="na">listener</span><span class="p">.</span><span class="na">get</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Create the Spark execution environment (cache, map output tracker, etc)  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createSparkEnv</span><span class="p">(</span><span class="n">_conf</span><span class="p">,</span><span class="w"> </span><span class="n">isLocal</span><span class="p">,</span><span class="w"> </span><span class="n">listenerBus</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">SparkEnv</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">_env</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_statusTracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkStatusTracker</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_statusStore</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_progressBar</span><span class="w"> </span><span class="o">=</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">UI_SHOW_CONSOLE_PROGRESS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Some</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ConsoleProgressBar</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">None</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_ui</span><span class="w"> </span><span class="o">=</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">UI_ENABLED</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Some</span><span class="p">(</span><span class="n">SparkUI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">Some</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="n">_statusStore</span><span class="p">,</span><span class="w"> </span><span class="n">_conf</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span><span class="p">.</span><span class="na">securityManager</span><span class="p">,</span><span class="w"> </span><span class="n">appName</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">startTime</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// For tests, do not enable the UI  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">None</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_hadoopConfiguration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SparkHadoopUtil</span><span class="p">.</span><span class="na">get</span><span class="p">.</span><span class="na">newConfiguration</span><span class="p">(</span><span class="n">_conf</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_executorMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SparkContext</span><span class="p">.</span><span class="na">executorMemoryInMb</span><span class="p">(</span><span class="n">_conf</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_shuffleDriverComponents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ShuffleDataIOUtils</span><span class="p">.</span><span class="na">loadShuffleDataIO</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="na">driver</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_shuffleDriverComponents</span><span class="p">.</span><span class="na">initializeApplication</span><span class="p">().</span><span class="na">asScala</span><span class="p">.</span><span class="na">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">_conf</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">ShuffleDataIOUtils</span><span class="p">.</span><span class="na">SHUFFLE_SPARK_CONF_PREFIX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// We need to register &#34;HeartbeatReceiver&#34; before &#34;createTaskScheduler&#34; because Executor will  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// retrieve &#34;HeartbeatReceiver&#34; in the constructor. (SPARK-6640)  _heartbeatReceiver = env.rpcEnv.setupEndpoint(  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">HeartbeatReceiver</span><span class="p">.</span><span class="na">ENDPOINT_NAME</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HeartbeatReceiver</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Initialize any plugins before the task scheduler is initialized.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_plugins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PluginContainer</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_resources</span><span class="p">.</span><span class="na">asJava</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Create and start the scheduler  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="p">(</span><span class="n">sched</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SparkContext</span><span class="p">.</span><span class="na">createTaskScheduler</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">master</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_schedulerBackend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_taskScheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_dagScheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DAGScheduler</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_heartbeatReceiver</span><span class="p">.</span><span class="na">ask</span><span class="o">[</span><span class="n">Boolean</span><span class="o">]</span><span class="p">(</span><span class="n">TaskSchedulerIsSet</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">_executorMetricsSource</span><span class="w"> </span><span class="o">=</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">METRICS_EXECUTORMETRICS_SOURCE_ENABLED</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Some</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ExecutorMetricsSource</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">None</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// create and start the heartbeater for collecting memory metrics  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_heartbeater</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Heartbeater</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">SparkContext</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">reportHeartBeat</span><span class="p">(</span><span class="n">_executorMetricsSource</span><span class="p">),</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;driver-heartbeater&#34;</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">EXECUTOR_HEARTBEAT_INTERVAL</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_heartbeater</span><span class="p">.</span><span class="na">start</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// start TaskScheduler after taskScheduler sets DAGScheduler reference in DAGScheduler&#39;s  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// constructor  _taskScheduler.start()  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_applicationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_taskScheduler</span><span class="p">.</span><span class="na">applicationId</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_applicationAttemptId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_taskScheduler</span><span class="p">.</span><span class="na">applicationAttemptId</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_conf</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="s">&#34;spark.app.id&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">_applicationId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_applicationAttemptId</span><span class="p">.</span><span class="na">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">attemptId</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">_conf</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">APP_ATTEMPT_ID</span><span class="p">,</span><span class="w"> </span><span class="n">attemptId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">_env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">blockStoreClient</span><span class="p">.</span><span class="na">setAppAttemptId</span><span class="p">(</span><span class="n">attemptId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">UI_REVERSE_PROXY</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">proxyUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">UI_REVERSE_PROXY_URL</span><span class="p">).</span><span class="na">getOrElse</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">).</span><span class="na">stripSuffix</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&#34;spark.ui.proxyBase&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">proxyUrl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;/proxy/&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_applicationId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_ui</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">setAppId</span><span class="p">(</span><span class="n">_applicationId</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">_applicationId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">FallbackStorage</span><span class="p">.</span><span class="na">registerBlockManagerIfNeeded</span><span class="p">(</span><span class="n">_env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">master</span><span class="p">,</span><span class="w"> </span><span class="n">_conf</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_cleaner</span><span class="w"> </span><span class="o">=</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">CLEANER_REFERENCE_TRACKING</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Some</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ContextCleaner</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_shuffleDriverComponents</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">None</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_cleaner</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">start</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">dynamicAllocationEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Utils</span><span class="p">.</span><span class="na">isDynamicAllocationEnabled</span><span class="p">(</span><span class="n">_conf</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_executorAllocationManager</span><span class="w"> </span><span class="o">=</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dynamicAllocationEnabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">schedulerBackend</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="n">ExecutorAllocationClient</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Some</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ExecutorAllocationManager</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">schedulerBackend</span><span class="p">.</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">ExecutorAllocationClient</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">listenerBus</span><span class="p">,</span><span class="w"> </span><span class="n">_conf</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">cleaner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cleaner</span><span class="p">,</span><span class="w"> </span><span class="n">resourceProfileManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceProfileManager</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">None</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">None</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_executorAllocationManager</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">start</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">setupAndStartListenerBus</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">postEnvironmentUpdate</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">postApplicationStart</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// After application started, attach handlers to started server and start handler.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_ui</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">attachAllHandler</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Attach the driver metrics servlet handler to the web ui after the metrics system is started.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_env</span><span class="p">.</span><span class="na">metricsSystem</span><span class="p">.</span><span class="na">getServletHandlers</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">handler</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ui</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">attachHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Make sure the context is stopped if the user forgets about it. This avoids leaving  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// unfinished event logs around after the JVM exits cleanly. It doesn&#39;t help if the JVM  // is killed, though.  logDebug(&#34;Adding shutdown hook&#34;) // force eager creation of logger  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_shutdownHookRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ShutdownHookManager</span><span class="p">.</span><span class="na">addShutdownHook</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ShutdownHookManager</span><span class="p">.</span><span class="na">SPARK_CONTEXT_SHUTDOWN_PRIORITY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Invoking stop() from shutdown hook&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">stop</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logWarning</span><span class="p">(</span><span class="s">&#34;Ignoring Exception while stopping SparkContext from shutdown hook&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Post init  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_taskScheduler</span><span class="p">.</span><span class="na">postStartHook</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isLocal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">_env</span><span class="p">.</span><span class="na">metricsSystem</span><span class="p">.</span><span class="na">registerSource</span><span class="p">(</span><span class="n">Executor</span><span class="p">.</span><span class="na">executorSourceLocalModeOnly</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_env</span><span class="p">.</span><span class="na">metricsSystem</span><span class="p">.</span><span class="na">registerSource</span><span class="p">(</span><span class="n">_dagScheduler</span><span class="p">.</span><span class="na">metricsSource</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_env</span><span class="p">.</span><span class="na">metricsSystem</span><span class="p">.</span><span class="na">registerSource</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BlockManagerSource</span><span class="p">(</span><span class="n">_env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_env</span><span class="p">.</span><span class="na">metricsSystem</span><span class="p">.</span><span class="na">registerSource</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JVMCPUSource</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_executorMetricsSource</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">_env</span><span class="p">.</span><span class="na">metricsSystem</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_executorAllocationManager</span><span class="p">.</span><span class="na">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">_env</span><span class="p">.</span><span class="na">metricsSystem</span><span class="p">.</span><span class="na">registerSource</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">executorAllocationManagerSource</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">appStatusSource</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_env</span><span class="p">.</span><span class="na">metricsSystem</span><span class="p">.</span><span class="na">registerSource</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">_plugins</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">registerMetrics</span><span class="p">(</span><span class="n">applicationId</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">...</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过<code>SparkContext.createTaskScheduler(this, master)</code>创建了<code>SchedulerBackend</code>与<code>TaskScheduler</code>. 之后又创建了<code>DAGScheduler</code>.
先来看<code>TaskScheduler</code>的创建过程:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">createTaskScheduler</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sc</span><span class="p">:</span><span class="w"> </span><span class="n">SparkContext</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">master</span><span class="p">:</span><span class="w"> </span><span class="n">String</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="n">SchedulerBackend</span><span class="p">,</span><span class="w"> </span><span class="n">TaskScheduler</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kn">import</span><span class="w"> </span><span class="nn">SparkMasterRegex._</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">master</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;local&#34;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">checkResourcesPerTask</span><span class="p">(</span><span class="n">1</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskSchedulerImpl</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_LOCAL_TASK_FAILURES</span><span class="p">,</span><span class="w"> </span><span class="n">isLocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LocalSchedulerBackend</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="na">getConf</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">(</span><span class="n">backend</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">LOCAL_N_REGEX</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">def</span><span class="w"> </span><span class="n">localCpuCount</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">.</span><span class="na">availableProcessors</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// local[*] estimates the number of cores on the machine; local[N] uses exactly N threads.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">threadCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#34;*&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">localCpuCount</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">threads</span><span class="p">.</span><span class="na">toInt</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadCount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkException</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Asked to run locally with $threadCount threads&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">checkResourcesPerTask</span><span class="p">(</span><span class="n">threadCount</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskSchedulerImpl</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_LOCAL_TASK_FAILURES</span><span class="p">,</span><span class="w"> </span><span class="n">isLocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LocalSchedulerBackend</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="na">getConf</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">threadCount</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">(</span><span class="n">backend</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">LOCAL_N_FAILURES_REGEX</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span><span class="w"> </span><span class="n">maxFailures</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">def</span><span class="w"> </span><span class="n">localCpuCount</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">.</span><span class="na">availableProcessors</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// local[*, M] means the number of cores on the computer with M failures  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// local[N, M] means exactly N threads with M failures      val threadCount = if (threads == &#34;*&#34;) localCpuCount else threads.toInt  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">checkResourcesPerTask</span><span class="p">(</span><span class="n">threadCount</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskSchedulerImpl</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">maxFailures</span><span class="p">.</span><span class="na">toInt</span><span class="p">,</span><span class="w"> </span><span class="n">isLocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LocalSchedulerBackend</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="na">getConf</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">threadCount</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">(</span><span class="n">backend</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">SPARK_REGEX</span><span class="p">(</span><span class="n">sparkUrl</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskSchedulerImpl</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">masterUrls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparkUrl</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="s">&#34;spark://&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StandaloneSchedulerBackend</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">masterUrls</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">(</span><span class="n">backend</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">LOCAL_CLUSTER_REGEX</span><span class="p">(</span><span class="n">numWorkers</span><span class="p">,</span><span class="w"> </span><span class="n">coresPerWorker</span><span class="p">,</span><span class="w"> </span><span class="n">memoryPerWorker</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">checkResourcesPerTask</span><span class="p">(</span><span class="n">coresPerWorker</span><span class="p">.</span><span class="na">toInt</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Check to make sure memory requested &lt;= memoryPerWorker. Otherwise Spark will just hang.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">memoryPerWorkerInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memoryPerWorker</span><span class="p">.</span><span class="na">toInt</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="na">executorMemory</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">memoryPerWorkerInt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkException</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s">&#34;Asked to launch cluster with %d MiB/worker but requested %d MiB/executor&#34;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">memoryPerWorkerInt</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">.</span><span class="na">executorMemory</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// For host local mode setting the default of SHUFFLE_HOST_LOCAL_DISK_READING_ENABLED  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// to false because this mode is intended to be used for testing and in this case all the      // executors are running on the same host. So if host local reading was enabled here then      // testing of the remote fetching would be secondary as setting this config explicitly to      // false would be required in most of the unit test (despite the fact that remote fetching      // is much more frequent in production).   </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="n">sc</span><span class="p">.</span><span class="na">conf</span><span class="p">.</span><span class="na">setIfMissing</span><span class="p">(</span><span class="n">SHUFFLE_HOST_LOCAL_DISK_READING_ENABLED</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TaskSchedulerImpl</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">localCluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalSparkCluster</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">numWorkers</span><span class="p">.</span><span class="na">toInt</span><span class="p">,</span><span class="w"> </span><span class="n">coresPerWorker</span><span class="p">.</span><span class="na">toInt</span><span class="p">,</span><span class="w"> </span><span class="n">memoryPerWorkerInt</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">.</span><span class="na">conf</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">masterUrls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localCluster</span><span class="p">.</span><span class="na">start</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StandaloneSchedulerBackend</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">masterUrls</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">backend</span><span class="p">.</span><span class="na">shutdownCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">backend</span><span class="p">:</span><span class="w"> </span><span class="n">StandaloneSchedulerBackend</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">localCluster</span><span class="p">.</span><span class="na">stop</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">(</span><span class="n">backend</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">masterUrl</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">cm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClusterManager</span><span class="p">(</span><span class="n">masterUrl</span><span class="p">)</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">clusterMgr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">clusterMgr</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkException</span><span class="p">(</span><span class="s">&#34;Could not parse Master URL: &#39;&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;&#39;&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="na">createTaskScheduler</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">masterUrl</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="na">createSchedulerBackend</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">masterUrl</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cm</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">backend</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="n">backend</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">se</span><span class="p">:</span><span class="w"> </span><span class="n">SparkException</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">se</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nf">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkException</span><span class="p">(</span><span class="s">&#34;External scheduler cannot be instantiated&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里其实是对我们任务提交类型的判断, 从而选择不同的实现类.
而后续的<code>DAGScheduler</code>创建, 传入了<code>SparkContext</code>与<code>TaskScheduler</code>参数, 在DAGScheduler内部做了<code>TaskScheduler</code>与<code>DAGScheduler</code>的绑定
<code>taskScheduler.setDAGScheduler(this)</code>
SparkContext初始化时, 相当于完成了基础的准备工作.</p>
<p>后续当用户的action算子触发计算时, 会调用<code>dagScheduler</code>来做任务的划分与分配.
在<code>JavaWordCount</code>这个例子中, 当调用<code>collect</code>算子时, 最终会调用到<code>SparkContext</code>类中的<code>runJob</code>方法.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="n">runJob</span><span class="o">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">:</span><span class="w"> </span><span class="n">ClassTag</span><span class="o">]</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rdd</span><span class="p">:</span><span class="w"> </span><span class="n">RDD</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">TaskContext</span><span class="p">,</span><span class="w"> </span><span class="n">Iterator</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">partitions</span><span class="p">:</span><span class="w"> </span><span class="n">Seq</span><span class="o">[</span><span class="n">Int</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">resultHandler</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">Int</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Unit</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stopped</span><span class="p">.</span><span class="na">get</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;SparkContext has been shutdown&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">callSite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCallSite</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">cleanedFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clean</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Starting job: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callSite</span><span class="p">.</span><span class="na">shortForm</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="na">getBoolean</span><span class="p">(</span><span class="s">&#34;spark.logLineage&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;RDD&#39;s recursive dependencies:\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rdd</span><span class="p">.</span><span class="na">toDebugString</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">dagScheduler</span><span class="p">.</span><span class="na">runJob</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">cleanedFunc</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">,</span><span class="w"> </span><span class="n">resultHandler</span><span class="p">,</span><span class="w"> </span><span class="n">localProperties</span><span class="p">.</span><span class="na">get</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">progressBar</span><span class="p">.</span><span class="na">foreach</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">finishAll</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">rdd</span><span class="p">.</span><span class="na">doCheckpoint</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dagscheduler">DAGScheduler</h2>
<p>通过上面的代码可以知道, 这里调用了<code>dagScheduler</code>来提交任务.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="n">runJob</span><span class="o">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">]</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rdd</span><span class="p">:</span><span class="w"> </span><span class="n">RDD</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">TaskContext</span><span class="p">,</span><span class="w"> </span><span class="n">Iterator</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">partitions</span><span class="p">:</span><span class="w"> </span><span class="n">Seq</span><span class="o">[</span><span class="n">Int</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">callSite</span><span class="p">:</span><span class="w"> </span><span class="n">CallSite</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">resultHandler</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">Int</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Unit</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">properties</span><span class="p">:</span><span class="w"> </span><span class="n">Properties</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">waiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">submitJob</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">,</span><span class="w"> </span><span class="n">resultHandler</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">ThreadUtils</span><span class="p">.</span><span class="na">awaitReady</span><span class="p">(</span><span class="n">waiter</span><span class="p">.</span><span class="na">completionFuture</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">Inf</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">waiter</span><span class="p">.</span><span class="na">completionFuture</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">get</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">scala</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Success</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Job %d finished: %s, took %f s&#34;</span><span class="p">.</span><span class="na">format</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="n">waiter</span><span class="p">.</span><span class="na">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">.</span><span class="na">shortForm</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">1e9</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">scala</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Failure</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Job %d failed: %s, took %f s&#34;</span><span class="p">.</span><span class="na">format</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="n">waiter</span><span class="p">.</span><span class="na">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">.</span><span class="na">shortForm</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">1e9</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// SPARK-8644: Include user stack trace in exceptions coming from DAGScheduler.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">callerStackTrace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getStackTrace</span><span class="p">.</span><span class="na">tail</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">exception</span><span class="p">.</span><span class="na">setStackTrace</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="na">getStackTrace</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">callerStackTrace</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="n">exception</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>DAGScheduler</code>里又调用了<code>submitJob</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="n">submitJob</span><span class="o">[</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">]</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rdd</span><span class="p">:</span><span class="w"> </span><span class="n">RDD</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">TaskContext</span><span class="p">,</span><span class="w"> </span><span class="n">Iterator</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">partitions</span><span class="p">:</span><span class="w"> </span><span class="n">Seq</span><span class="o">[</span><span class="n">Int</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">callSite</span><span class="p">:</span><span class="w"> </span><span class="n">CallSite</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">resultHandler</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">Int</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Unit</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">properties</span><span class="p">:</span><span class="w"> </span><span class="n">Properties</span><span class="p">):</span><span class="w"> </span><span class="n">JobWaiter</span><span class="o">[</span><span class="n">U</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextJobId</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">func2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="p">(</span><span class="n">TaskContext</span><span class="p">,</span><span class="w"> </span><span class="n">Iterator</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_</span><span class="o">]</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">waiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JobWaiter</span><span class="o">[</span><span class="n">U</span><span class="o">]</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">.</span><span class="na">size</span><span class="p">,</span><span class="w"> </span><span class="n">resultHandler</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">eventProcessLoop</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">JobSubmitted</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">func2</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">.</span><span class="na">toArray</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">,</span><span class="w"> </span><span class="n">waiter</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Utils</span><span class="p">.</span><span class="na">cloneProperties</span><span class="p">(</span><span class="n">properties</span><span class="p">)))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">waiter</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>向<code>eventProcessLoop</code>发送了<code>JobSubmitted</code>的消息, 消息内包含了任务的基础信息.
<strong>这里的调用采用了消息传递, 而不是直接的方法调用.</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">doOnReceive</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="w"> </span><span class="n">DAGSchedulerEvent</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">JobSubmitted</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">,</span><span class="w"> </span><span class="n">listener</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">dagScheduler</span><span class="p">.</span><span class="na">handleJobSubmitted</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">,</span><span class="w"> </span><span class="n">listener</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当<code>DagScheduler</code>收到消息后, 做模式匹配, 我们上面提交的<code>JobSubmitter</code>消息会调用<code>handleJobSubmitter</code>方法来处理.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="o">[</span><span class="n">scheduler</span><span class="o">]</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">handleJobSubmitted</span><span class="p">(</span><span class="n">jobId</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">finalRDD</span><span class="p">:</span><span class="w"> </span><span class="n">RDD</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">TaskContext</span><span class="p">,</span><span class="w"> </span><span class="n">Iterator</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">partitions</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">[</span><span class="n">Int</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">callSite</span><span class="p">:</span><span class="w"> </span><span class="n">CallSite</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">listener</span><span class="p">:</span><span class="w"> </span><span class="n">JobListener</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">properties</span><span class="p">:</span><span class="w"> </span><span class="n">Properties</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">finalStage</span><span class="p">:</span><span class="w"> </span><span class="n">ResultStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// New stage creation may throw an exception if, for example, jobs are run on a  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// HadoopRDD whose underlying HDFS files have been deleted.    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">finalStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createResultStage</span><span class="p">(</span><span class="n">finalRDD</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">,</span><span class="w"> </span><span class="n">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Job submitted, clear internal data.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">barrierJobIdToNumTasksCheckFailures</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ActiveJob</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">finalStage</span><span class="p">,</span><span class="w"> </span><span class="n">callSite</span><span class="p">,</span><span class="w"> </span><span class="n">listener</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">clearCacheLocs</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">jobSubmissionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock</span><span class="p">.</span><span class="na">getTimeMillis</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">jobIdToActiveJob</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">job</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">activeJobs</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">job</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">finalStage</span><span class="p">.</span><span class="na">setActiveJob</span><span class="p">(</span><span class="n">job</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">stageIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jobIdToStageIds</span><span class="p">(</span><span class="n">jobId</span><span class="p">).</span><span class="na">toArray</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">stageInfos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageIds</span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">stageIdToStage</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">latestInfo</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">listenerBus</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SparkListenerJobStart</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">jobSubmissionTime</span><span class="p">,</span><span class="w"> </span><span class="n">stageInfos</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Utils</span><span class="p">.</span><span class="na">cloneProperties</span><span class="p">(</span><span class="n">properties</span><span class="p">)))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">submitStage</span><span class="p">(</span><span class="n">finalStage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>根据传入的RDD获取最后一步的<code>Stage</code>信息, 最后调用<code>submitStage</code>方法.
先来看下如何获取的<code>finalStage</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">createResultStage</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rdd</span><span class="p">:</span><span class="w"> </span><span class="n">RDD</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">TaskContext</span><span class="p">,</span><span class="w"> </span><span class="n">Iterator</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">partitions</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">[</span><span class="n">Int</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jobId</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">callSite</span><span class="p">:</span><span class="w"> </span><span class="n">CallSite</span><span class="p">):</span><span class="w"> </span><span class="n">ResultStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="p">(</span><span class="n">shuffleDeps</span><span class="p">,</span><span class="w"> </span><span class="n">resourceProfiles</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getShuffleDependenciesAndResourceProfiles</span><span class="p">(</span><span class="n">rdd</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">resourceProfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mergeResourceProfilesForStage</span><span class="p">(</span><span class="n">resourceProfiles</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">checkBarrierStageWithDynamicAllocation</span><span class="p">(</span><span class="n">rdd</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">checkBarrierStageWithNumSlots</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">resourceProfile</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">checkBarrierStageWithRDDChainPattern</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">.</span><span class="na">toSet</span><span class="p">.</span><span class="na">size</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">parents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrCreateParentStages</span><span class="p">(</span><span class="n">shuffleDeps</span><span class="p">,</span><span class="w"> </span><span class="n">jobId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextStageId</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ResultStage</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">partitions</span><span class="p">,</span><span class="w"> </span><span class="n">parents</span><span class="p">,</span><span class="w"> </span><span class="n">jobId</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">callSite</span><span class="p">,</span><span class="w"> </span><span class="n">resourceProfile</span><span class="p">.</span><span class="na">id</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">stageIdToStage</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">updateJobIdStageIdMaps</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">stage</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>其实我们知道Spark里根据是否需要做Shuffle来划分Stage, 那么这里就会根据一个RDD的所有依赖做划分, 这个切分就是在这里根据RDD的dependency信息做的.
当切分完成后, 会创建一个<code>ResultStage</code>表示这是最后一个<code>Stage</code>. 这个<code>Stage</code>里会有一个<code>parents</code>的Stage信息.</p>
<p>我们再来看下<code>submitStage</code>的代码部分</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">submitStage</span><span class="p">(</span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Stage</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeJobForStage</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jobId</span><span class="p">.</span><span class="na">isDefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;submitStage($stage (name=${stage.name};&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">s</span><span class="s">&#34;jobs=${stage.jobIds.toSeq.sorted.mkString(&#34;</span><span class="p">,</span><span class="s">&#34;)}))&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">waitingStages</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">runningStages</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">failedStages</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getMissingParentStages</span><span class="p">(</span><span class="n">stage</span><span class="p">).</span><span class="na">sortBy</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">id</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logDebug</span><span class="p">(</span><span class="s">&#34;missing: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">missing</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">missing</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Submitting &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; (&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">rdd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;), which has no missing parents&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">submitMissingTasks</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">jobId</span><span class="p">.</span><span class="na">get</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">missing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">submitStage</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">waitingStages</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stage</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">abortStage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;No active job for stage &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">None</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当收到<code>finialStage</code>后, 可以看到做的事情是先获取<code>Parent Stage</code>. 当<code>Parent Stage</code>为空时才会提交自身的Stage, 不然会先计算<code>Parent Stage</code>.
<code>Stage</code>是有依赖关系的, 所有当计算最后一个Stage时需要先完成之前所有Stage的计算.
注意当有上游依赖时, 循环提交完成后还向 <code>waitingStages</code>添加了自身的<code>Stage</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">submitMissingTasks</span><span class="p">(</span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">Stage</span><span class="p">,</span><span class="w"> </span><span class="n">jobId</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="s">&#34;submitMissingTasks(&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;)&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Figure out the indexes of partition ids to compute.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">partitionsToCompute</span><span class="p">:</span><span class="w"> </span><span class="n">Seq</span><span class="o">[</span><span class="n">Int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">findMissingPartitions</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">runningStages</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stage</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// SparkListenerStageSubmitted should be posted before testing whether tasks are  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// serializable. If tasks are not serializable, a SparkListenerStageCompleted event  // will be posted, which should always come after a corresponding SparkListenerStageSubmitted  // event.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">stage</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ShuffleMapStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">outputCommitCoordinator</span><span class="p">.</span><span class="na">stageStart</span><span class="p">(</span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">maxPartitionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">numPartitions</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Only generate merger location for a given shuffle dependency once.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">shuffleDep</span><span class="p">.</span><span class="na">shuffleMergeAllowed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="na">shuffleDep</span><span class="p">.</span><span class="na">isShuffleMergeFinalizedMarked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">prepareShuffleServicesForShuffleMapStage</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// Disable Shuffle merge for the retry/reuse of the same shuffle dependency if it has  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// already been merge finalized. If the shuffle dependency was previously assigned          // merger locations but the corresponding shuffle map stage did not complete          // successfully, we would still enable push for its retry.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">s</span><span class="p">.</span><span class="na">shuffleDep</span><span class="p">.</span><span class="na">setShuffleMergeAllowed</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Push-based shuffle disabled for $stage (${stage.name}) since it&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34; is already shuffle merge finalized&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ResultStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">outputCommitCoordinator</span><span class="p">.</span><span class="na">stageStart</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">maxPartitionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">rdd</span><span class="p">.</span><span class="na">partitions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">taskIdToLocations</span><span class="p">:</span><span class="w"> </span><span class="n">Map</span><span class="o">[</span><span class="n">Int</span><span class="p">,</span><span class="w"> </span><span class="n">Seq</span><span class="o">[</span><span class="n">TaskLocation</span><span class="o">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ShuffleMapStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">partitionsToCompute</span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">getPreferredLocs</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">))}.</span><span class="na">toMap</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ResultStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">partitionsToCompute</span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">partitions</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">getPreferredLocs</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}.</span><span class="na">toMap</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">stage</span><span class="p">.</span><span class="na">makeNewStageAttempt</span><span class="p">(</span><span class="n">partitionsToCompute</span><span class="p">.</span><span class="na">size</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">listenerBus</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">SparkListenerStageSubmitted</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">latestInfo</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Utils</span><span class="p">.</span><span class="na">cloneProperties</span><span class="p">(</span><span class="n">properties</span><span class="p">)))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">abortStage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="s">&#34;Task creation failed: $e\n${Utils.exceptionString(e)}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">runningStages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">stage</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">stage</span><span class="p">.</span><span class="na">makeNewStageAttempt</span><span class="p">(</span><span class="n">partitionsToCompute</span><span class="p">.</span><span class="na">size</span><span class="p">,</span><span class="w"> </span><span class="n">taskIdToLocations</span><span class="p">.</span><span class="na">values</span><span class="p">.</span><span class="na">toSeq</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// If there are tasks to execute, record the submission time of the stage. Otherwise,  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// post the even without the submission time, which indicates that this stage was  // skipped.  if (partitionsToCompute.nonEmpty) {  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stage</span><span class="p">.</span><span class="na">latestInfo</span><span class="p">.</span><span class="na">submissionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="na">getTimeMillis</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">listenerBus</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">SparkListenerStageSubmitted</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">latestInfo</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Utils</span><span class="p">.</span><span class="na">cloneProperties</span><span class="p">(</span><span class="n">properties</span><span class="p">)))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// TODO: Maybe we can keep the taskBinary in Stage to avoid serializing it multiple times.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Broadcasted binary for the task, used to dispatch tasks to executors. Note that we broadcast  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// the serialized copy of the RDD and for each task we will deserialize it, which means each  // task gets a different copy of the RDD. This provides stronger isolation between tasks that  // might modify state of objects referenced in their closures. This is necessary in Hadoop  // where the JobConf/Configuration object is not thread-safe.  var taskBinary: Broadcast[Array[Byte]] = null  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">partitions</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">[</span><span class="n">Partition</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// For ShuffleMapTask, serialize and broadcast (rdd, shuffleDep).  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// For ResultTask, serialize and broadcast (rdd, func).    var taskBinaryBytes: Array[Byte] = null  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// taskBinaryBytes and partitions are both effected by the checkpoint status. We need  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// this synchronization in case another concurrent job is checkpointing this RDD, so we get a    // consistent view of both variables.    RDDCheckpointData.synchronized {  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">taskBinaryBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">ShuffleMapStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">JavaUtils</span><span class="p">.</span><span class="na">bufferToArray</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">closureSerializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">((</span><span class="n">stage</span><span class="p">.</span><span class="na">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">shuffleDep</span><span class="p">):</span><span class="w"> </span><span class="n">AnyRef</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">ResultStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">JavaUtils</span><span class="p">.</span><span class="na">bufferToArray</span><span class="p">(</span><span class="n">closureSerializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">((</span><span class="n">stage</span><span class="p">.</span><span class="na">rdd</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">func</span><span class="p">):</span><span class="w"> </span><span class="n">AnyRef</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">partitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">rdd</span><span class="p">.</span><span class="na">partitions</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskBinaryBytes</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TaskSetManager</span><span class="p">.</span><span class="na">TASK_SIZE_TO_WARN_KIB</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">1024</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Broadcasting large task binary with size &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">s</span><span class="s">&#34;${Utils.bytesToString(taskBinaryBytes.length)}&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">taskBinary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sc</span><span class="p">.</span><span class="na">broadcast</span><span class="p">(</span><span class="n">taskBinaryBytes</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// In the case of a failure during serialization, abort the stage.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">NotSerializableException</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">abortStage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Task not serializable: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">,</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">runningStages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">stage</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Abort execution  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">abortStage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="s">&#34;Task serialization failed: $e\n${Utils.exceptionString(e)}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">runningStages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">stage</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Abort execution  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">tasks</span><span class="p">:</span><span class="w"> </span><span class="n">Seq</span><span class="o">[</span><span class="n">Task</span><span class="o">[</span><span class="n">_</span><span class="o">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">serializedTaskMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closureSerializer</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">latestInfo</span><span class="p">.</span><span class="na">taskMetrics</span><span class="p">).</span><span class="na">array</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">ShuffleMapStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">stage</span><span class="p">.</span><span class="na">pendingPartitions</span><span class="p">.</span><span class="na">clear</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">partitionsToCompute</span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="n">locs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskIdToLocations</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partitions</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">stage</span><span class="p">.</span><span class="na">pendingPartitions</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">id</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">new</span><span class="w"> </span><span class="nf">ShuffleMapTask</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">latestInfo</span><span class="p">.</span><span class="na">attemptNumber</span><span class="p">,</span><span class="w"> </span><span class="n">taskBinary</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">numPartitions</span><span class="p">,</span><span class="w"> </span><span class="n">locs</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">,</span><span class="w"> </span><span class="n">serializedTaskMetrics</span><span class="p">,</span><span class="w"> </span><span class="n">Option</span><span class="p">(</span><span class="n">jobId</span><span class="p">),</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Option</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="na">applicationId</span><span class="p">),</span><span class="w"> </span><span class="n">sc</span><span class="p">.</span><span class="na">applicationAttemptId</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">rdd</span><span class="p">.</span><span class="na">isBarrier</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">ResultStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">partitionsToCompute</span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">partitions</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partitions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">val</span><span class="w"> </span><span class="n">locs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskIdToLocations</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">new</span><span class="w"> </span><span class="n">ResultTask</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">latestInfo</span><span class="p">.</span><span class="na">attemptNumber</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">taskBinary</span><span class="p">,</span><span class="w"> </span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">numPartitions</span><span class="p">,</span><span class="w"> </span><span class="n">locs</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">,</span><span class="w"> </span><span class="n">serializedTaskMetrics</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Option</span><span class="p">(</span><span class="n">jobId</span><span class="p">),</span><span class="w"> </span><span class="n">Option</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="na">applicationId</span><span class="p">),</span><span class="w"> </span><span class="n">sc</span><span class="p">.</span><span class="na">applicationAttemptId</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stage</span><span class="p">.</span><span class="na">rdd</span><span class="p">.</span><span class="na">isBarrier</span><span class="p">())</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">abortStage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="s">&#34;Task creation failed: $e\n${Utils.exceptionString(e)}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">runningStages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">stage</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="na">nonEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Submitting ${tasks.size} missing tasks from $stage (${stage.rdd}) (first 15 &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">s</span><span class="s">&#34;tasks are for partitions ${tasks.take(15).map(_.partitionId)})&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">shuffleId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ShuffleMapStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">shuffleDep</span><span class="p">.</span><span class="na">shuffleId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="n">ResultStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">None</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">taskScheduler</span><span class="p">.</span><span class="na">submitTasks</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TaskSet</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">tasks</span><span class="p">.</span><span class="na">toArray</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">latestInfo</span><span class="p">.</span><span class="na">attemptNumber</span><span class="p">,</span><span class="w"> </span><span class="n">jobId</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">stage</span><span class="p">.</span><span class="na">resourceProfileId</span><span class="p">,</span><span class="w"> </span><span class="n">shuffleId</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Because we posted SparkListenerStageSubmitted earlier, we should mark  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// the stage as completed here in case there are no tasks to run    markStageAsFinished(stage, None)  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stage</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">stage</span><span class="p">:</span><span class="w"> </span><span class="n">ShuffleMapStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Stage ${stage} is actually done; &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;(available: ${stage.isAvailable},&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;available outputs: ${stage.numAvailableOutputs},&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;partitions: ${stage.numPartitions})&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">markMapStageJobsAsFinished</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ResultStage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Stage ${stage} is actually done; (partitions: ${stage.numPartitions})&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">submitWaitingChildStages</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码上面的部分是如何去创建<code>Task</code>, 当<code>tasks</code>不为空是会调用<code>taskScheduler.submitTask</code>来提交Task. <code>Task</code>的信息是通过<code>sparkContext.broadcast</code>来广播到每个executor上的.
注意当有上游依赖时,<code>finialStage</code>还在<code>waitingStages</code>中.</p>
<h2 id="taskscheduler">TaskScheduler</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">override</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">submitTasks</span><span class="p">(</span><span class="n">taskSet</span><span class="p">:</span><span class="w"> </span><span class="n">TaskSet</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskSet</span><span class="p">.</span><span class="na">tasks</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">logInfo</span><span class="p">(</span><span class="s">&#34;Adding task set &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">taskSet</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; with &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tasks</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; tasks &#34;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;resource profile &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">taskSet</span><span class="p">.</span><span class="na">resourceProfileId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">synchronized</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createTaskSetManager</span><span class="p">(</span><span class="n">taskSet</span><span class="p">,</span><span class="w"> </span><span class="n">maxTaskFailures</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskSet</span><span class="p">.</span><span class="na">stageId</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">stageTaskSets</span><span class="w"> </span><span class="o">=</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">taskSetsByStageIdAndAttempt</span><span class="p">.</span><span class="na">getOrElseUpdate</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">[</span><span class="n">Int</span><span class="p">,</span><span class="w"> </span><span class="n">TaskSetManager</span><span class="o">]</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stageTaskSets</span><span class="p">.</span><span class="na">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ts</span><span class="p">.</span><span class="na">isZombie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stageTaskSets</span><span class="p">(</span><span class="n">taskSet</span><span class="p">.</span><span class="na">stageAttemptId</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">manager</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">schedulableBuilder</span><span class="p">.</span><span class="na">addTaskSetManager</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="na">taskSet</span><span class="p">.</span><span class="na">properties</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isLocal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">hasReceivedTask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">starvationTimer</span><span class="p">.</span><span class="na">scheduleAtFixedRate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TimerTask</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">override</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">hasLaunchedTask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logWarning</span><span class="p">(</span><span class="s">&#34;Initial job has not accepted any resources; &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s">&#34;check your cluster UI to ensure that workers are registered &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s">&#34;and have sufficient resources&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">cancel</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="n">STARVATION_TIMEOUT_MS</span><span class="p">,</span><span class="w"> </span><span class="n">STARVATION_TIMEOUT_MS</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">hasReceivedTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">backend</span><span class="p">.</span><span class="na">reviveOffers</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>创建完<code>TaskSetManager</code>后, 调用了<code>SchedulerBackend.reviverOffers</code>.
<code>SchedulerBackend</code>的实现类为<code>CoarseGrainedSchedulerBackend</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">override</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">reviveOffers</span><span class="p">():</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Utils</span><span class="p">.</span><span class="na">tryLogNonFatalError</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">driverEndpoint</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">ReviveOffers</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">override</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">receive</span><span class="p">:</span><span class="w"> </span><span class="n">PartialFunction</span><span class="o">[</span><span class="n">Any</span><span class="p">,</span><span class="w"> </span><span class="n">Unit</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">case</span><span class="w"> </span><span class="n">ReviveOffers</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="n">makeOffers</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">makeOffers</span><span class="p">():</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Make sure no executor is killed while some task is launching on it  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">taskDescs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">withLock</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Filter out executors under killing  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">activeExecutors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executorDataMap</span><span class="p">.</span><span class="na">filterKeys</span><span class="p">(</span><span class="n">isExecutorActive</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">workOffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeExecutors</span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">executorData</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">buildWorkerOffer</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">executorData</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}.</span><span class="na">toIndexedSeq</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">scheduler</span><span class="p">.</span><span class="na">resourceOffers</span><span class="p">(</span><span class="n">workOffers</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskDescs</span><span class="p">.</span><span class="na">nonEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">launchTasks</span><span class="p">(</span><span class="n">taskDescs</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">launchTasks</span><span class="p">(</span><span class="n">tasks</span><span class="p">:</span><span class="w"> </span><span class="n">Seq</span><span class="o">[</span><span class="n">Seq</span><span class="o">[</span><span class="n">TaskDescription</span><span class="o">]]</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tasks</span><span class="p">.</span><span class="na">flatten</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">serializedTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TaskDescription</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serializedTask</span><span class="p">.</span><span class="na">limit</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxRpcMessageSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Option</span><span class="p">(</span><span class="n">scheduler</span><span class="p">.</span><span class="na">taskIdToTaskSetManager</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">taskId</span><span class="p">)).</span><span class="na">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">taskSetMgr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;Serialized task %s:%d was %d bytes, which exceeds max allowed: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;${RPC_MESSAGE_MAX_SIZE.key} (%d bytes). Consider increasing &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;${RPC_MESSAGE_MAX_SIZE.key} or using broadcast variables for large values.&#34;</span><span class="w">          </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">taskId</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="na">index</span><span class="p">,</span><span class="w"> </span><span class="n">serializedTask</span><span class="p">.</span><span class="na">limit</span><span class="p">(),</span><span class="w"> </span><span class="n">maxRpcMessageSize</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">taskSetMgr</span><span class="p">.</span><span class="na">abort</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">logError</span><span class="p">(</span><span class="s">&#34;Exception in error callback&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">executorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executorDataMap</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">executorId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Do resources allocation here. The allocated resources will get released after the task  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// finishes.      executorData.freeCores -= task.cpus  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">task</span><span class="p">.</span><span class="na">resources</span><span class="p">.</span><span class="na">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">rName</span><span class="p">,</span><span class="w"> </span><span class="n">rInfo</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">assert</span><span class="p">(</span><span class="n">executorData</span><span class="p">.</span><span class="na">resourcesInfo</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">rName</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executorData</span><span class="p">.</span><span class="na">resourcesInfo</span><span class="p">(</span><span class="n">rName</span><span class="p">).</span><span class="na">acquire</span><span class="p">(</span><span class="n">rInfo</span><span class="p">.</span><span class="na">addresses</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Launching task ${task.taskId} on executor id: ${task.executorId} hostname: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">s</span><span class="s">&#34;${executorData.executorHost}.&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">executorData</span><span class="p">.</span><span class="na">executorEndpoint</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">LaunchTask</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SerializableBuffer</span><span class="p">(</span><span class="n">serializedTask</span><span class="p">)))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里将task编码后, 发送到每个executor上.</p>
<h1 id="executor">Executor</h1>
<p>在executor上, 当接受到<code>LauncherTask</code>类型的消息时</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">override</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">receive</span><span class="p">:</span><span class="w"> </span><span class="n">PartialFunction</span><span class="o">[</span><span class="n">Any</span><span class="p">,</span><span class="w"> </span><span class="n">Unit</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">..</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">LaunchTask</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">executor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">exitExecutor</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Received LaunchTask command but executor was null&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">taskDesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TaskDescription</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">value</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Got assigned task &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">taskDesc</span><span class="p">.</span><span class="na">taskId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">taskResources</span><span class="p">(</span><span class="n">taskDesc</span><span class="p">.</span><span class="na">taskId</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taskDesc</span><span class="p">.</span><span class="na">resources</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">executor</span><span class="p">.</span><span class="na">launchTask</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">taskDesc</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>反序列化化Task信息, 然后交到线程池中执行.
当任务完成后, <code>TaskSetManager</code>中的方法会将信息发送给<code>DagScheduler</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="nf">handleSuccessfulTask</span><span class="p">(</span><span class="n">tid</span><span class="p">:</span><span class="w"> </span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="n">DirectTaskResult</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">sched</span><span class="p">.</span><span class="na">dagScheduler</span><span class="p">.</span><span class="na">taskEnded</span><span class="p">(</span><span class="n">tasks</span><span class="p">(</span><span class="n">index</span><span class="p">),</span><span class="w"> </span><span class="n">Success</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">value</span><span class="p">(),</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">accumUpdates</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">result</span><span class="p">.</span><span class="na">metricPeaks</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>DAGScheduler</code>中,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="nf">taskEnded</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">task</span><span class="p">:</span><span class="w"> </span><span class="n">Task</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">reason</span><span class="p">:</span><span class="w"> </span><span class="n">TaskEndReason</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="n">Any</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">accumUpdates</span><span class="p">:</span><span class="w"> </span><span class="n">Seq</span><span class="o">[</span><span class="n">AccumulatorV2</span><span class="o">[</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">]]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">metricPeaks</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="o">[</span><span class="n">Long</span><span class="o">]</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">taskInfo</span><span class="p">:</span><span class="w"> </span><span class="n">TaskInfo</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">eventProcessLoop</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CompletionEvent</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">accumUpdates</span><span class="p">,</span><span class="w"> </span><span class="n">metricPeaks</span><span class="p">,</span><span class="w"> </span><span class="n">taskInfo</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="o">[</span><span class="n">scheduler</span><span class="o">]</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">handleTaskCompletion</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="w"> </span><span class="n">CompletionEvent</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">event</span><span class="p">.</span><span class="na">reason</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">Success</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">task</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">smt</span><span class="p">:</span><span class="w"> </span><span class="n">ShuffleMapTask</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="n">shuffleStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">ShuffleMapStage</span><span class="o">]</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">shuffleStage</span><span class="p">.</span><span class="na">pendingPartitions</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="na">partitionId</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">result</span><span class="p">.</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">MapStatus</span><span class="o">]</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="n">execId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">.</span><span class="na">location</span><span class="p">.</span><span class="na">executorId</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nf">logDebug</span><span class="p">(</span><span class="s">&#34;ShuffleMapTask finished on &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">execId</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">executorFailureEpoch</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">execId</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">smt</span><span class="p">.</span><span class="na">epoch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">executorFailureEpoch</span><span class="p">(</span><span class="n">execId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Ignoring possibly bogus $smt completion from executor $execId&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// The epoch of the task is acceptable (i.e., the task was launched after the most  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// recent failure we&#39;re aware of for the executor), so mark the task&#39;s output as          // available.          mapOutputTracker.registerMapOutput(  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">shuffleStage</span><span class="p">.</span><span class="na">shuffleDep</span><span class="p">.</span><span class="na">shuffleId</span><span class="p">,</span><span class="w"> </span><span class="n">smt</span><span class="p">.</span><span class="na">partitionId</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runningStages</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">shuffleStage</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shuffleStage</span><span class="p">.</span><span class="na">pendingPartitions</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">shuffleStage</span><span class="p">.</span><span class="na">shuffleDep</span><span class="p">.</span><span class="na">isShuffleMergeFinalizedMarked</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">shuffleStage</span><span class="p">.</span><span class="na">shuffleDep</span><span class="p">.</span><span class="na">getMergerLocs</span><span class="p">.</span><span class="na">nonEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">checkAndScheduleShuffleMergeFinalize</span><span class="p">(</span><span class="n">shuffleStage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">processShuffleMapStageCompletion</span><span class="p">(</span><span class="n">shuffleStage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里有一句<code>processShuffleMapStageCompletion(shuffleStage)</code>, 当有上游依赖时<code>ResultStage</code>会被放到<code>waitingStages</code>, 还未被执行.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">processShuffleMapStageCompletion</span><span class="p">(</span><span class="n">shuffleStage</span><span class="p">:</span><span class="w"> </span><span class="n">ShuffleMapStage</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">markStageAsFinished</span><span class="p">(</span><span class="n">shuffleStage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;looking for newly runnable stages&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;running: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">runningStages</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;waiting: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">waitingStages</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;failed: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">failedStages</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">mapOutputTracker</span><span class="p">.</span><span class="na">incrementEpoch</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">clearCacheLocs</span><span class="p">()</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">shuffleStage</span><span class="p">.</span><span class="na">isAvailable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Some tasks had failed; let&#39;s resubmit this shuffleStage.  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// TODO: Lower-level scheduler should also deal with this  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Resubmitting &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shuffleStage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; (&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shuffleStage</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="s">&#34;) because some of its tasks had failed: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">shuffleStage</span><span class="p">.</span><span class="na">findMissingPartitions</span><span class="p">().</span><span class="na">mkString</span><span class="p">(</span><span class="s">&#34;, &#34;</span><span class="p">))</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">submitStage</span><span class="p">(</span><span class="n">shuffleStage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">markMapStageJobsAsFinished</span><span class="p">(</span><span class="n">shuffleStage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">submitWaitingChildStages</span><span class="p">(</span><span class="n">shuffleStage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">submitWaitingChildStages</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span><span class="w"> </span><span class="n">Stage</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logTrace</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Checking if any dependencies of $parent are now runnable&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logTrace</span><span class="p">(</span><span class="s">&#34;running: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">runningStages</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logTrace</span><span class="p">(</span><span class="s">&#34;waiting: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">waitingStages</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logTrace</span><span class="p">(</span><span class="s">&#34;failed: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">failedStages</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">childStages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitingStages</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">parents</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">parent</span><span class="p">)).</span><span class="na">toArray</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">waitingStages</span><span class="w"> </span><span class="o">--=</span><span class="w"> </span><span class="n">childStages</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">for</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">childStages</span><span class="p">.</span><span class="na">sortBy</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="na">firstJobId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">submitStage</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里会将Stage从<code>waitingStages</code>中拿出来, 然后重新提交.</p>

    </article>
  </main>
  

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css"
    integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"
    integrity="sha384-YNHdsYkH6gMx9y3mRkmcJ2mFUjTd0qNQQvY9VYZgQd7DcN7env35GzlmFaZ23JGp"
    crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"
    integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl"
    crossorigin="anonymous"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            
            
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true }
            ],
            
            throwOnError: false
        });
    });
</script>





<script 
  src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"
  crossorigin="anonymous">
</script>
<script>
  mermaid.init(undefined, 'code.language-mermaid')
</script>




</div>


  <footer class="mt-8 mb-8">
  <div class="container mx-auto">
    <div class="mt-8 flex flex-col-reverse sm:flex-row sm:justify-between items-center">
      <div class="text-center sm:text-left">
        <p class="mt-0 text-sm"></p>
        <p class="mt-0 text-xs">
          Built with <a href="https://gohugo.io" target="_blank" rel="noopener noreferrer">Hugo</a> v0.140.0
          and <a href="https://github.com/mivinci/hugo-theme-minima" target="_blank" rel="noopener noreferrer">Minima</a>
        </p>
      </div>
      
      <p class="flex items-center mt-0">
        
          <a class="icon ml-1 mr-1" href="mailto:jarvis@apache.org" title="email">
          
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
          
          </a>
        
          <a class="icon ml-1 mr-1" href="https://github.com/liunaijie" title="github">
          
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
          
          </a>
        
          <a class="icon ml-1 mr-1" href="/index.xml" title="rss">
          
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
          
          </a>
        
      </p>
    </div>
  </div>
</footer>
</body>

</html>