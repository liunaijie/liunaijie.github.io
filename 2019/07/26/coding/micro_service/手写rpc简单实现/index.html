<!DOCTYPE html>
<html lang="zh-CN">

<head>

  <!-- Minima -->
  <!-- Hexo theme created by @adisaktijrs -->

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">

  
  <title>手写rpc简单实现</title>
  
  <link rel="canonical" href="https://www.liunaijie.top/2019/07/26/coding/micro_service/%E6%89%8B%E5%86%99rpc%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/">
  
  <meta name="description" content="背景当单体项目逐渐扩大后，一个项目编译，发布可能需要很久的时间，如果其中一个文件出现 bug，那么需要对整个项目进行打包发布。微服务就是对项目进行拆分，拆分成多个小项目，由这些小项目组成大项目。并且拆分成小项目后，其他单体项目中需要相同功能的地方就不用再次编写，直接用这个就可以了。有种分治的思想。 ">
  
  
  <meta name="keywords" content="blog">
  
  <meta name="author" content="Jarvis">
  
  
  
  <meta property="og:site_name" content="J.A.R.V.I.S" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="手写rpc简单实现" />
  
  <meta property="og:description" content="背景当单体项目逐渐扩大后，一个项目编译，发布可能需要很久的时间，如果其中一个文件出现 bug，那么需要对整个项目进行打包发布。微服务就是对项目进行拆分，拆分成多个小项目，由这些小项目组成大项目。并且拆分成小项目后，其他单体项目中需要相同功能的地方就不用再次编写，直接用这个就可以了。有种分治的思想。 ">
  
  <meta property="og:url" content="https://www.liunaijie.top/2019/07/26/coding/micro_service/%E6%89%8B%E5%86%99rpc%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="手写rpc简单实现">
  
  <meta name="twitter:description" content="背景当单体项目逐渐扩大后，一个项目编译，发布可能需要很久的时间，如果其中一个文件出现 bug，那么需要对整个项目进行打包发布。微服务就是对项目进行拆分，拆分成多个小项目，由这些小项目组成大项目。并且拆分成小项目后，其他单体项目中需要相同功能的地方就不用再次编写，直接用这个就可以了。有种分治的思想。 ">
  
  
  
  
  <meta name="twitter:url" content="https://www.liunaijie.top/2019/07/26/coding/micro_service/%E6%89%8B%E5%86%99rpc%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/" />

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Preload fonts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="preload" href="/fonts/dm-serif-display-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/inter-v2-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  
<link rel="stylesheet" href="/css/normalize.css">

  
<link rel="stylesheet" href="/css/skeleton.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
<link rel="stylesheet" href="/css/prism-dark.css">

  
<link rel="stylesheet" href="/css/prism-line-numbers.css">

  <!-- User css -->
  

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="/images/jarvis.png">

  <!-- Custom Theme Color Style
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <style>
  a:not(.icon) {
    text-decoration-color: #0FA0CE;
    background-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 50%,
      #0FA0CE 50%
    );
  }
  blockquote {
    border-left: 8px solid #0FA0CE;
  }
  .nanobar .bar {
    background: #0FA0CE;
  }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    background-color: #0FA0CE;
    border-color: #0FA0CE;
  }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #0FA0CE;
  }
</style>

  <!-- Google Analytics (With Privacy Settings On)
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  

  
  <script src="/js/pic.min.js" defer></script>
  

  

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="J.A.R.V.I.S" type="application/atom+xml">
</head>

<body>
  <div class="container">
    <div class="row">
      <div>

        <div class="row">
  <div class="two columns" style="max-width: 50px">
    <h1 class="mt-2 mode">
      <div onclick=setDarkMode(true) id="darkBtn"></div>
      <div onclick=setDarkMode(false) id="lightBtn" class=hidden></div>
      <script >
        if (localStorage.getItem('preferredTheme') == 'dark') {
          setDarkMode(true)
        }
        function setDarkMode(isDark) {
          var darkBtn = document.getElementById('darkBtn')
          var lightBtn = document.getElementById('lightBtn')
          if (isDark) {
            lightBtn.style.display = "block"
            darkBtn.style.display = "none"
            localStorage.setItem('preferredTheme', 'dark');
          } else {
            lightBtn.style.display = "none"
            darkBtn.style.display = "block"
            localStorage.removeItem('preferredTheme');
          }
          document.body.classList.toggle("darkmode");
        }
      </script>
    </h1>
  </div>

  <div class="six columns ml-1">
    <h1 class="mt-2">
      Jarvis&#39;s Blog
    </h1>
  </div>

  <div class="twelve columns">
    <div class="row">
      <div class="nine columns left">
        
          
          <a href="/" class="ml">Home</a>
          
        
          
          <a href="/categories/publish/" class="ml">Publish</a>
          
        
          
          <a href="/about" class="ml">About</a>
          
        
          
          <a href="/atom.xml" class="ml">Rss</a>
          
        
      </div>
    </div>
    <hr style="margin-bottom: 2.6rem">
  </div>
</div>

        <div class="trans">
            <h2>手写rpc简单实现</h2>

  <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>当单体项目逐渐扩大后，一个项目编译，发布可能需要很久的时间，如果其中一个文件出现 bug，那么需要对整个项目进行打包发布。微服务就是对项目进行拆分，拆分成多个小项目，由这些小项目组成大项目。并且拆分成小项目后，其他单体项目中需要相同功能的地方就不用再次编写，直接用这个就可以了。有种<code>分治</code>的思想。</p>
<p>那么原来单体项目拆分后，随之而来就会出现一些问题。原来一个项目中直接调用即可，现在请求的类被拆分到其他项目中，如何进行请求，是采用 http 这种请求还是rpc？多个模块如果进行管理等等一系列问题。这里主要写一下 rpc 的理解。</p>
<p>在微服务中rpc又是重要的一环，现在主流的rpc框架有很多，比如阿里的<code>dubbo</code>，微博的<code>Motan</code>,谷歌的<code>gRpc</code>，还有<code>Thrift</code>，现在主流的应该就这几种吧。按照文档学习了一下<code>dubbo</code>如何使用后，发现并没有了解rpc是如何具体实现的。所以这篇文章记录了自己对rpc的一些理解与实战代码。  </p>
<p><a target="_blank" rel="noopener" href="https://github.com/liunaijie/learn-demo/tree/master/learn-demo-rpc">代码链接</a></p>
<h1 id="HTTP-与-RPC-的对比"><a href="#HTTP-与-RPC-的对比" class="headerlink" title="HTTP 与 RPC 的对比"></a>HTTP 与 RPC 的对比</h1><p>其实就像一些技术一样，没有绝对好的技术，不然大家都去使用它了。都只是在不同场景下有各自的优势。</p>
<ul>
<li>rpc一般是自带负载均衡策略，而 http 一般是通过 nginx 这种来实现负载均衡</li>
<li>rpc可以使用 tcp 协议也可以使用 http 协议，而 http 就只能使用 http 协议</li>
<li>rpc可以自定义传输信息和序列化方法，减少传输报文大小。</li>
</ul>
<p>所以RPC主要用于公司内部的服务调用。HTTP主要用于对外的环境，浏览器接口调用，APP接口调用，第三方接口调用等。</p>
<h1 id="RPC的主要实现步骤"><a href="#RPC的主要实现步骤" class="headerlink" title="RPC的主要实现步骤"></a>RPC的主要实现步骤</h1><p><img src="https://raw.githubusercontent.com/liunaijie/images/master/RPC%E8%B0%83%E7%94%A8.png" alt="RPC调用流程"></p>
<span id="more"></span>

<h1 id="各个模块的作用"><a href="#各个模块的作用" class="headerlink" title="各个模块的作用"></a>各个模块的作用</h1><ul>
<li><p>封装rpc请求</p>
<p>我们在调用其他代码的时候要让别人知道我们调用的是什么类的什么方法，传递了什么参数等信息。所以我们需要将这些信息进行封装起来，然后进行传输。</p>
</li>
<li><p>序列化与反序列化</p>
<p>这个主要是传输数据的大小和跨语言的实现，不同的序列化方式会导致我们在网络传输中传输大小不同的信息，所以这个也是影响性能的一部分    </p>
<p>跨语言：这个就像我们说话的方言一样，我们说的方言怎么能让其他人听懂呢，那我们就都说普通话吧，这样大家就比较好理解你的意思了。在编程语言的世界里，<code>java</code>说的话怎么能让<code>go</code>,<code>php</code>等语言听懂呢？我们就定一个协议吧，大家都遵守这个协议，就能明白干什么了，所以<code>gRpc</code>和<code>Thrift</code>就使用了这种的序列化规则。那么有人就说了，既然能使用<code>*普通话*</code>这个标准，为什么其他的框架不用呢？其实这就看公司使用的技术了，如果各个部门都使用的是同一种技术框架，也没有发展其他语言的项目（都是一个地方的人说同一种方言），就没有必要非去弄<code>*普通话*</code>了。</p>
</li>
<li><p>网络传输</p>
<p>序列化完成的数据在网络进行传输，比如现在大部分都在使用的<code>netty</code>技术。</p>
</li>
<li><p>负载均衡</p>
<p>消费者从注册中心（如果有）获取生产者的ip地址要进行通信了，但是这些生产者的性能可能不一样，我们可以对性能好的多访问几次，性能差的少访问几次。最简单的方式就是轮询，有几个生产者就轮着来，这个基本上都是针对自己公司情况来实现。</p>
</li>
<li><p>动态代理</p>
<p>在消费者调用生产者时，我们只需调用接口就能接收到返回信息，那么什么时候封装rpc请求了呢，怎么从注册中心找的节点信息等。这里就用到了aop的原理。并且我们不可能仅仅调用一个方法，如果使用静态代理，那么我们有多少个类就要有多个的代理，并且框架也不知道我们会有什么类，所以就需要使用动态代理。动态代理的作用主要是：<strong>在不改变目标对象方法的情况下对方法进行增强</strong></p>
</li>
<li><p>反射</p>
<p>动态代理其实也是基于反射实现的，常见的动态代理有：<strong>JDK动态代理</strong>，<strong>Cglib</strong>。  </p>
<p>jdk动态代理就是基于反射机制实现的。这些东西我也没有具体去理解去看这一块，我想应该是类似这样的：并不清楚调用的具体类是什么，使用一个<code>Object</code>类型来接收，只有当你真正调用的时候才知道这个类是<code>student</code>还是<code>teacher</code>，知道了之后再去调用。</p>
</li>
</ul>
<h1 id="项目模块"><a href="#项目模块" class="headerlink" title="项目模块"></a>项目模块</h1><p>这里在网络传输使用<code>bio</code>的方式，序列化就使用<code>java</code>默认的序列化方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">learn-demo-rpc</span><br><span class="line">├── bio-socket</span><br><span class="line">├── nio-socket</span><br><span class="line">├── simple-api</span><br><span class="line">├── rpc-common</span><br><span class="line">├── simple-rpc</span><br><span class="line">	├── simple-rpc-consumer</span><br><span class="line">	├── simple-rpc-provider</span><br><span class="line">	└── simple-rpc-core</span><br><span class="line">└── zookeeper-register-rpc</span><br><span class="line">	├── zookeeper-register-consumer</span><br><span class="line">	├── zookeeper-register-provider</span><br><span class="line">	└── zookeeper-register-core</span><br></pre></td></tr></table></figure>

<ul>
<li>bio-socket 以bio的方式实现生产者与消费者之间的通信模块</li>
<li>nio-socket 以nio的方式实现生产者与消费者之间的通信模块</li>
<li>simple-api 是定义的公共接口模块</li>
<li>rpc-common 对rpc请求和响应包装的一些实体类</li>
<li>simple-rpc 无注册中心的简单rpc调用实现</li>
<li>Zookeeper-register-rpc 通过zookeeper注册中心的rpc调用实现<ol>
<li>-core 是核心实现模块</li>
<li>-provider 是生产者的实现模块</li>
<li>-consumer 是消费者的调用模块</li>
</ol>
</li>
</ul>
<h1 id="定义接口模块和对应请求响应的包装类"><a href="#定义接口模块和对应请求响应的包装类" class="headerlink" title="定义接口模块和对应请求响应的包装类"></a>定义接口模块和对应请求响应的包装类</h1><h2 id="接口模块"><a href="#接口模块" class="headerlink" title="接口模块"></a>接口模块</h2><p>这个模块就比较简单了，写个接口，写个方法就可以了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ISayHello</span> &#123;</span><br><span class="line"></span><br><span class="line">	String <span class="title function_">sayHello</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="包装请求和响应信息"><a href="#包装请求和响应信息" class="headerlink" title="包装请求和响应信息"></a>包装请求和响应信息</h2><p>这里就要考虑了，我们如果调用一个方法，需要知道一些什么东西才能调用呢。我们在本地调用一个的时候是这样调用的<code>ClassA.methodB(paramC,paramD)</code>，那现在我们知道了classA，所以其他的就是下面这几个了：方法名，参数类型，参数。  </p>
<p>返回信息的时候需要返回一些什么信息呢。首先肯定有个请求方法的返回值，其他的还需要什么呢，参考了一下网络调用的返回信息，我又添加了状态码，提示信息这两个字段。  </p>
<p>然后序列化方式就用默认的方式即可，实现个接口然后定义id就可以了。  </p>
<h3 id="请求信息"><a href="#请求信息" class="headerlink" title="请求信息"></a>请求信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">5837872617706737632L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 方法名称</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String methodName;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 参数列表</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Object[] parameters;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 参数类型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt;[] parameterTypes;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getMethodName</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> methodName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcRequest <span class="title function_">setMethodName</span><span class="params">(String methodName)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.methodName = methodName;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Object[] getParameters() &#123;</span><br><span class="line">		<span class="keyword">return</span> parameters;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcRequest <span class="title function_">setParameters</span><span class="params">(Object[] parameters)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.parameters = parameters;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Class&lt;?&gt;[] getParameterTypes() &#123;</span><br><span class="line">		<span class="keyword">return</span> parameterTypes;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcRequest <span class="title function_">setParameterTypes</span><span class="params">(Class&lt;?&gt;[] parameterTypes)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.parameterTypes = parameterTypes;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;RpcRequest&#123;&quot;</span> +</span><br><span class="line">				<span class="string">&quot;methodName=&#x27;&quot;</span> + methodName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">				<span class="string">&quot;, parameters=&quot;</span> + Arrays.toString(parameters) +</span><br><span class="line">				<span class="string">&quot;, parameterTypes=&quot;</span> + Arrays.toString(parameterTypes) +</span><br><span class="line">				<span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="响应信息"><a href="#响应信息" class="headerlink" title="响应信息"></a>响应信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcResponse</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">4129585144798112980L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求成功的响应码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">SUCCEED</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求失败的响应码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">FAILED</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 响应状态，默认就是成功的</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 响应信息，如异常信息</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 响应数据，返回值</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStatus</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcResponse <span class="title function_">setStatus</span><span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.status = status;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcResponse <span class="title function_">setMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.message = message;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcResponse <span class="title function_">setData</span><span class="params">(Object data)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.data = data;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;RpcResponse&#123;&quot;</span> +</span><br><span class="line">				<span class="string">&quot;status=&#x27;&quot;</span> + status + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">				<span class="string">&quot;, message=&#x27;&quot;</span> + message + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">				<span class="string">&quot;, data=&quot;</span> + data +</span><br><span class="line">				<span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="定义bio的socket通信模块"><a href="#定义bio的socket通信模块" class="headerlink" title="定义bio的socket通信模块"></a>定义bio的socket通信模块</h1><p>也试过使用nio的方式，但是返回信息在子线程里面返回了，需要使用线程通知机制，后面研究后会再更新。</p>
<h2 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h2><p>提供了一个开启服务端的方法，传入端口，请求的类名和实现类即可  </p>
<p>收到客户端发送的消息后先将其转换为对象，判断客户端发送的信息是不是我们包装好的rpc请求信息，如果是rpc请求那么我们再进行处理，并将结果进行返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BioServer</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(BioServer.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(<span class="type">int</span> port, Class&lt;?&gt; interfaceClass, T ref)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			log.info(<span class="string">&quot; bio rpc server is starting,address:&#123;&#125;,port:&#123;&#125; &quot;</span>, InetAddress.getLocalHost().getHostAddress(), port);</span><br><span class="line"></span><br><span class="line">			<span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">				<span class="comment">// 获取客户端的连接</span></span><br><span class="line">				<span class="type">Socket</span> <span class="variable">client</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 获取客户端发送的数据</span></span><br><span class="line">				<span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(client.getInputStream());</span><br><span class="line"></span><br><span class="line">				<span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (object <span class="keyword">instanceof</span> RpcRequest) &#123;</span><br><span class="line">					<span class="type">RpcRequest</span> <span class="variable">request</span> <span class="operator">=</span> (RpcRequest) object;</span><br><span class="line">					log.info(<span class="string">&quot;bio rpc server get the client request:&#123;&#125;&quot;</span>, request);</span><br><span class="line">					<span class="comment">// 处理请求</span></span><br><span class="line">					<span class="type">RpcResponse</span> <span class="variable">response</span> <span class="operator">=</span> handleRequest(request, interfaceClass, ref);</span><br><span class="line">					<span class="comment">//将请求结果返回客户端</span></span><br><span class="line">					<span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(client.getOutputStream());</span><br><span class="line">					objectOutputStream.writeObject(response);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">&quot;bio rpc server start failed:&#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 处理请求</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request        rpc请求包装类</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> interfaceClass 接口类</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ref            实现类</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> RpcResponse <span class="title function_">handleRequest</span><span class="params">(RpcRequest request, Class&lt;?&gt; interfaceClass, T ref)</span> &#123;</span><br><span class="line">		<span class="type">RpcResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcResponse</span>();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> interfaceClass.getMethod(request.getMethodName(), request.getParameterTypes());</span><br><span class="line">			<span class="type">Object</span> <span class="variable">data</span> <span class="operator">=</span> method.invoke(ref, request.getParameters());</span><br><span class="line">			response.setData(data);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			response.setStatus(RpcResponse.FAILED).setMessage(e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> response;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h2><p>客户端的调用在设置好服务端的ip和端口后就可以直接发送数据了，发送的数据格式也是我们进行封装过的，返回信息格式也是我们进行封装完成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BioClient</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(BioClient.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getAddress</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> address;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddress</span><span class="params">(String address)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.address = address;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPort</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> port;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPort</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.port = port;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcResponse <span class="title function_">send</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(address, port);</span><br><span class="line">			<span class="comment">// 发送rpc请求</span></span><br><span class="line">			<span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(socket.getOutputStream());</span><br><span class="line">			objectOutputStream.writeObject(rpcRequest);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 接收响应</span></span><br><span class="line">			<span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line">			<span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">			<span class="keyword">if</span> (object <span class="keyword">instanceof</span> RpcResponse) &#123;</span><br><span class="line">				<span class="keyword">return</span> (RpcResponse) object;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">&quot;the rpc client start failed:&#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="无注册中心的简单rpc调用"><a href="#无注册中心的简单rpc调用" class="headerlink" title="无注册中心的简单rpc调用"></a>无注册中心的简单rpc调用</h1><h2 id="核心实现"><a href="#核心实现" class="headerlink" title="核心实现"></a>核心实现</h2><h3 id="生产者："><a href="#生产者：" class="headerlink" title="生产者："></a>生产者：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(RpcProvider.class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 接口类</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 具体实现类</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> T interfaceImpl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInterfaceImpl</span><span class="params">(T ref)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.interfaceImpl = ref;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcProvider&lt;T&gt; <span class="title function_">setInterfaceClass</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.interfaceClass = interfaceClass;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">		<span class="type">BioServer</span> <span class="variable">bioServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BioServer</span>();</span><br><span class="line">		bioServer.export(port, interfaceClass, interfaceImpl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcConsumer <span class="title function_">setAddress</span><span class="params">(String address)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.address = address;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcConsumer <span class="title function_">setPort</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.port = port;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcConsumer <span class="title function_">setInterface</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.interfaceClass = interfaceClass;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">BioClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BioClient</span>();</span><br><span class="line">		client.setAddress(address);</span><br><span class="line">		client.setPort(port);</span><br><span class="line">		<span class="comment">// 实例化RPC代理处理器</span></span><br><span class="line">		<span class="type">RpcInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcInvocationHandler</span>(client);</span><br><span class="line">		<span class="keyword">return</span> (T) Proxy.newProxyInstance(interfaceClass.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;interfaceClass&#125;, handler);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="代理类："><a href="#代理类：" class="headerlink" title="代理类："></a>代理类：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> BioClient bioClient;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcInvocationHandler</span><span class="params">(BioClient bioClient)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.bioClient = bioClient;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">		<span class="comment">//构建rpc请求对象</span></span><br><span class="line">		<span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcRequest</span>();</span><br><span class="line">		rpcRequest.setMethodName(method.getName())</span><br><span class="line">				.setParameterTypes(method.getParameterTypes())</span><br><span class="line">				.setParameters(args);</span><br><span class="line">		<span class="comment">//发送请求</span></span><br><span class="line">		<span class="type">RpcResponse</span> <span class="variable">rpcResponse</span> <span class="operator">=</span> bioClient.send(rpcRequest);</span><br><span class="line">		<span class="comment">// 返回响应结果</span></span><br><span class="line">		<span class="keyword">if</span> (RpcResponse.SUCCEED == rpcResponse.getStatus()) &#123;</span><br><span class="line">			<span class="keyword">return</span> rpcResponse.getData();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(rpcResponse.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><h3 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRpcProviderImpl</span> <span class="keyword">implements</span> <span class="title class_">ISayHello</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hello,&quot;</span> + name + <span class="string">&quot;\n I am simple rpc provider.&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调用类"><a href="#调用类" class="headerlink" title="调用类"></a>调用类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRpcBioProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="comment">// 初始化实现类</span></span><br><span class="line">		<span class="type">SimpleRpcProviderImpl</span> <span class="variable">simpleRpcProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRpcProviderImpl</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//初始化rpc请求类</span></span><br><span class="line">		RpcProvider&lt;ISayHello&gt; provider = <span class="keyword">new</span> <span class="title class_">RpcProvider</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">// 设置 接口类 和 具体实现类</span></span><br><span class="line">		provider.setInterfaceClass(ISayHello.class)</span><br><span class="line">				.setInterfaceImpl(simpleRpcProvider);</span><br><span class="line">		<span class="comment">// 设置通信端口</span></span><br><span class="line">		provider.export(<span class="number">9090</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="消费者-1"><a href="#消费者-1" class="headerlink" title="消费者"></a>消费者</h2><h3 id="调用类-1"><a href="#调用类-1" class="headerlink" title="调用类"></a>调用类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRpcBioConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="comment">// 初始化消费者对象并设置参数</span></span><br><span class="line">		<span class="type">RpcConsumer</span> <span class="variable">rpcConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcConsumer</span>();</span><br><span class="line">		rpcConsumer.setAddress(<span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">				.setPort(<span class="number">9090</span>)</span><br><span class="line">				<span class="comment">// 设置请求消费的接口</span></span><br><span class="line">				.setInterface(ISayHello.class);</span><br><span class="line"></span><br><span class="line">		<span class="type">ISayHello</span> <span class="variable">iSayHello</span> <span class="operator">=</span> rpcConsumer.get();</span><br><span class="line">		System.out.println(iSayHello.sayHello(<span class="string">&quot;niki&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样就实现了一个简单的rpc调用。</p>
<h1 id="使用zookeeper作为注册中心的简单实现"><a href="#使用zookeeper作为注册中心的简单实现" class="headerlink" title="使用zookeeper作为注册中心的简单实现"></a>使用zookeeper作为注册中心的简单实现</h1><p>使用zookeeper后主要添加的东西是：</p>
<ul>
<li>生产者启动后向注册中心注册</li>
<li>消费者调用时先向注册中心请求节点信息（没有加缓存）</li>
<li>负载就使用随机访问。</li>
</ul>
<h2 id="核心实现-1"><a href="#核心实现-1" class="headerlink" title="核心实现"></a>核心实现</h2><h3 id="生产者-1"><a href="#生产者-1" class="headerlink" title="生产者"></a>生产者</h3><p>定义了几个参数，主要是实现类，接口类，注册中心的类。  </p>
<p>定义了启动<code>bio socket</code>通信的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcProvider</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(RpcProvider.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> T interfaceImpl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> RpcZKRegistryService rpcZKRegistryService;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInterfaceImpl</span><span class="params">(T interfaceImpl)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.interfaceImpl = interfaceImpl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcProvider&lt;T&gt; <span class="title function_">setInterfaceClass</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.interfaceClass = interfaceClass;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcProvider&lt;T&gt; <span class="title function_">setRpcZKRegistryService</span><span class="params">(String zkConnectString)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.rpcZKRegistryService = <span class="keyword">new</span> <span class="title class_">RpcZKRegistryService</span>(zkConnectString);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">		<span class="type">ProviderInfo</span> <span class="variable">providerInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderInfo</span>();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			providerInfo.setAddress(InetAddress.getLocalHost().getHostAddress())</span><br><span class="line">					.setPort(port)</span><br><span class="line">					.setId(interfaceClass.getName());</span><br><span class="line">			<span class="comment">// 将生产者信息注册到zk注册中心</span></span><br><span class="line">			rpcZKRegistryService.register(providerInfo);</span><br><span class="line">			<span class="type">BioServer</span> <span class="variable">bioServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BioServer</span>();</span><br><span class="line">			bioServer.export(port, interfaceClass, interfaceImpl);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">&quot; zookeeper server start failed:&#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="消费者-2"><a href="#消费者-2" class="headerlink" title="消费者"></a>消费者</h3><p>定义了要请求的接口类，注册中心的调用类   </p>
<p>定义了请求，获取节点，负载等方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String azConnectString;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求的接口类</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> RpcZKRegistryService rpcZKRegistryService;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcConsumer <span class="title function_">setZKConnectString</span><span class="params">(String zkConnectString)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.rpcZKRegistryService = <span class="keyword">new</span> <span class="title class_">RpcZKRegistryService</span>(zkConnectString);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> RpcConsumer <span class="title function_">setInterface</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.interfaceClass = interfaceClass;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">		List&lt;ProviderInfo&gt; providers = getProviders();</span><br><span class="line">		<span class="type">ProviderInfo</span> <span class="variable">provider</span> <span class="operator">=</span> chooseTarget(providers);</span><br><span class="line">		<span class="type">BioClient</span> <span class="variable">bioClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BioClient</span>();</span><br><span class="line">		bioClient.setAddress(provider.getAddress());</span><br><span class="line">		bioClient.setPort(provider.getPort());</span><br><span class="line">		<span class="type">RpcInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcInvocationHandler</span>(bioClient);</span><br><span class="line">		<span class="keyword">return</span> (T) Proxy.newProxyInstance(interfaceClass.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;interfaceClass&#125;, handler);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取所有的生产者信息</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;ProviderInfo&gt; <span class="title function_">getProviders</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//订阅服务</span></span><br><span class="line">		rpcZKRegistryService.subscribe(interfaceClass.getName());</span><br><span class="line">		<span class="comment">//获取所有的生产者信息</span></span><br><span class="line">		Map&lt;String, ProviderInfo&gt; providers = rpcZKRegistryService.getRemoteProviders();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(providers.values());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 模拟负载均衡</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> providerInfos 生产者列表</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ProviderInfo <span class="title function_">chooseTarget</span><span class="params">(List&lt;ProviderInfo&gt; providerInfos)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (providerInfos == <span class="literal">null</span> || providerInfos.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;providers is empty&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(providerInfos.size());</span><br><span class="line">		<span class="keyword">return</span> providerInfos.get(index);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="代理类"><a href="#代理类" class="headerlink" title="代理类"></a>代理类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> BioClient bioClient;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcInvocationHandler</span><span class="params">(BioClient bioClient)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.bioClient = bioClient;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">		<span class="comment">//构建请求对象</span></span><br><span class="line">		<span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcRequest</span>();</span><br><span class="line">		rpcRequest.setMethodName(method.getName())</span><br><span class="line">				.setParameterTypes(method.getParameterTypes())</span><br><span class="line">				.setParameters(args);</span><br><span class="line">		<span class="comment">//发送rpc请求</span></span><br><span class="line">		<span class="type">RpcResponse</span> <span class="variable">rpcResponse</span> <span class="operator">=</span> bioClient.send(rpcRequest);</span><br><span class="line">		<span class="keyword">if</span> (RpcResponse.SUCCEED == rpcResponse.getStatus()) &#123;</span><br><span class="line">			<span class="keyword">return</span> rpcResponse.getData();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(rpcResponse.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h3><p>每个节点的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProviderInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 提供者id</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 提供者的地址</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 提供者的端口</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> ProviderInfo <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.id = id;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getAddress</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> address;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> ProviderInfo <span class="title function_">setAddress</span><span class="params">(String address)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.address = address;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPort</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> port;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> ProviderInfo <span class="title function_">setPort</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.port = port;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toJsonString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> JSON.toJSONString(<span class="built_in">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;ProviderInfo&#123;&quot;</span> +</span><br><span class="line">				<span class="string">&quot;id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">				<span class="string">&quot;, address=&#x27;&quot;</span> + address + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">				<span class="string">&quot;, port=&quot;</span> + port +</span><br><span class="line">				<span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>java调用zk的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcZKRegistryService</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(RpcZKRegistryService.class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册的名称</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NAME_SPACE</span> <span class="operator">=</span> <span class="string">&quot;zk-rpc&quot;</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 节点信息</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RPC_PROVIDER_NODE</span> <span class="operator">=</span> <span class="string">&quot;/provider&quot;</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 保存多个生产者信息</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ProviderInfo&gt; remoteProviders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 客户端</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> CuratorFramework zkClient;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcZKRegistryService</span><span class="params">(String zkConnectString)</span> &#123;</span><br><span class="line">		<span class="comment">// 设置重试次数和两次重试间隔时间</span></span><br><span class="line">		<span class="type">RetryPolicy</span> <span class="variable">retryPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RetryNTimes</span>(<span class="number">3</span>, <span class="number">5000</span>);</span><br><span class="line">		<span class="comment">//获取客户端</span></span><br><span class="line">		<span class="built_in">this</span>.zkClient = CuratorFrameworkFactory.builder()</span><br><span class="line">				.connectString(zkConnectString)</span><br><span class="line">				.sessionTimeoutMs(<span class="number">10000</span>)</span><br><span class="line">				.retryPolicy(retryPolicy)</span><br><span class="line">				.namespace(NAME_SPACE)</span><br><span class="line">				.build();</span><br><span class="line">		<span class="built_in">this</span>.zkClient.start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册服务</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> providerInfo 生产者的信息</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(ProviderInfo providerInfo)</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">nodePath</span> <span class="operator">=</span> RPC_PROVIDER_NODE + <span class="string">&quot;/&quot;</span> + providerInfo.getId();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 判断节点是否存在，如果不存在则创建</span></span><br><span class="line">			<span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zkClient.checkExists().forPath(nodePath);</span><br><span class="line">			<span class="keyword">if</span> (stat == <span class="literal">null</span>) &#123;</span><br><span class="line">				zkClient.create()</span><br><span class="line">						.creatingParentsIfNeeded()</span><br><span class="line">						.withMode(CreateMode.EPHEMERAL_SEQUENTIAL)</span><br><span class="line">						.withACL(ZooDefs.Ids.OPEN_ACL_UNSAFE)</span><br><span class="line">						.forPath(nodePath, providerInfo.toJsonString().getBytes());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				log.error(<span class="string">&quot; thr provider already exists,&#123;&#125; &quot;</span>, providerInfo);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">&quot;zookeeper register provider failed,&#123;&#125;&quot;</span>, e.toString());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 订阅服务</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> id 生产者的id或者接口名称</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String id)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			List&lt;String&gt; providerIds = zkClient.getChildren().forPath(RPC_PROVIDER_NODE);</span><br><span class="line">			<span class="keyword">for</span> (String providerId : providerIds) &#123;</span><br><span class="line">				<span class="comment">//如果与订阅服务相同，则获取节点信息</span></span><br><span class="line">				<span class="keyword">if</span> (providerId.contains(id)) &#123;</span><br><span class="line">					<span class="type">String</span> <span class="variable">nodePath</span> <span class="operator">=</span> RPC_PROVIDER_NODE + <span class="string">&quot;/&quot;</span> + providerId;</span><br><span class="line">					<span class="type">byte</span>[] data = zkClient.getData().forPath(nodePath);</span><br><span class="line">					<span class="type">ProviderInfo</span> <span class="variable">providerInfo</span> <span class="operator">=</span> JSON.parseObject(data, ProviderInfo.class);</span><br><span class="line">					<span class="built_in">this</span>.remoteProviders.put(providerId, providerInfo);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//添加监听事件</span></span><br><span class="line">			addProviderWatch(id);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addProviderWatch</span><span class="params">(String id)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//创建子节点缓存</span></span><br><span class="line">			<span class="keyword">final</span> <span class="type">PathChildrenCache</span> <span class="variable">childrenCache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathChildrenCache</span>(<span class="built_in">this</span>.zkClient, RPC_PROVIDER_NODE, <span class="literal">true</span>);</span><br><span class="line">			childrenCache.start(PathChildrenCache.StartMode.BUILD_INITIAL_CACHE);</span><br><span class="line">			<span class="comment">//添加子节点监听事件</span></span><br><span class="line">			childrenCache.getListenable().addListener((client, event) -&gt; &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">nodePath</span> <span class="operator">=</span> event.getData().getPath();</span><br><span class="line">				<span class="keyword">if</span> (nodePath.contains(id)) &#123;</span><br><span class="line">					<span class="keyword">if</span> (event.getType().equals(PathChildrenCacheEvent.Type.CHILD_REMOVED)) &#123;</span><br><span class="line">						<span class="comment">//节点移除</span></span><br><span class="line">						<span class="built_in">this</span>.remoteProviders.remove(nodePath);</span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(PathChildrenCacheEvent.Type.CHILD_ADDED)) &#123;</span><br><span class="line">						<span class="type">byte</span>[] data = event.getData().getData();</span><br><span class="line">						<span class="type">ProviderInfo</span> <span class="variable">providerInfo</span> <span class="operator">=</span> JSON.parseObject(data, ProviderInfo.class);</span><br><span class="line">						<span class="comment">//添加节点</span></span><br><span class="line">						<span class="built_in">this</span>.remoteProviders.put(nodePath, providerInfo);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取节点列表</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> Map&lt;String, ProviderInfo&gt; <span class="title function_">getRemoteProviders</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> remoteProviders;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="生产者-2"><a href="#生产者-2" class="headerlink" title="生产者"></a>生产者</h2><h3 id="实现接口-1"><a href="#实现接口-1" class="headerlink" title="实现接口"></a>实现接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZkProviderImpl</span> <span class="keyword">implements</span> <span class="title class_">ISayHello</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hello &quot;</span> + name + <span class="string">&quot;\n i am zookeeper provider&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调用类-2"><a href="#调用类-2" class="headerlink" title="调用类"></a>调用类</h3><p>通过传入调用的类，zk的地址，实现的类进行注册中心注册。然后启动连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZKProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">ZkProviderImpl</span> <span class="variable">zkProviderImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZkProviderImpl</span>();</span><br><span class="line">		RpcProvider&lt;ISayHello&gt; provider = <span class="keyword">new</span> <span class="title class_">RpcProvider</span>&lt;&gt;();</span><br><span class="line">		provider.setInterfaceClass(ISayHello.class)</span><br><span class="line">				.setRpcZKRegistryService(<span class="string">&quot;localhost:2181&quot;</span>)</span><br><span class="line">				.setInterfaceImpl(zkProviderImpl);</span><br><span class="line">		provider.export(<span class="number">9090</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="消费者-3"><a href="#消费者-3" class="headerlink" title="消费者"></a>消费者</h2><h3 id="调用类-3"><a href="#调用类-3" class="headerlink" title="调用类"></a>调用类</h3><p>传入zk的地址，接口类。然后调用方法即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZKConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">RpcConsumer</span> <span class="variable">rpcConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcConsumer</span>();</span><br><span class="line">		rpcConsumer.setZKConnectString(<span class="string">&quot;localhost:2181&quot;</span>);</span><br><span class="line">		rpcConsumer.setInterface(ISayHello.class);</span><br><span class="line">		<span class="type">ISayHello</span> <span class="variable">iSayHello</span> <span class="operator">=</span> rpcConsumer.get();</span><br><span class="line">		System.out.println(iSayHello.sayHello(<span class="string">&quot;zookeeper&quot;</span>));</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<br>
<h2>Tags: </h2>
  <p><a class="classtest-link" href="/tags/Java/" rel="tag">Java</a>, <a class="classtest-link" href="/tags/Java-rpc/" rel="tag">Java/rpc</a> — 2019年7月26日</p>
  

  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>

        </div>
        <!-- <div class="row mt-2">
  <h3>Search</h3>
  <div><input id="search-text" title="search" class="search-text" type="text" placeholder="search......"></div>
  <div style="margin-top: 1.5rem;">
    <ul id="result"></ul>
  </div>
</div> -->
        <div class="row mt-2">
  
    <div class="eight columns">
      <p id="madewith">Made with ❤ and
        <a class="footer-link icon" href="https://hexo.io" target="_blank" style="text-decoration: none;" rel="noreferrer" aria-label="Hexo.io">
        <svg class="hexo svg-hov" width="14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Hexo.js</title><path d="M12 .007L1.57 6.056V18.05L12 23.995l10.43-6.049V5.952L12 .007zm4.798 17.105l-.939.521-.939-.521V12.94H9.08v4.172l-.94.521-.938-.521V6.89l.939-.521.939.521v4.172h5.84V6.89l.94-.521.938.521v10.222z"/></svg>
        </a>
        
    </div>

    <!-- Sepcial thanks to https://simpleicons.org/ for the icons -->
    <div class="four columns mb-3 posisi" >
      
      <a class="ml-0 footer-link icon" href="https://github.com/liunaijie" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="GitHub">
        <svg class="github svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      </a>
      

      

      

      

      
      
        <a class="ml-0 footer-link icon" href="mailto:jarvis@apache.org" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Email">
          <svg class="email svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Email</title><path d="M12 12.713l11.985-7.99c-.01-.01-11.985-7.723-11.985-7.723s-11.975 7.713-11.985 7.723l11.985 7.99zm0 2.287l-12-8v14h24v-14l-12 8z"/></svg>
        </a>
        
    </div>
  
</div>

      </div>

    </div>

  </div>
  <script src="/js/nanobar.min.js"></script>

  <script>
    var options = {
      classname: 'nanobar',
      id: 'myNanobar'
    };
    var nanobar = new Nanobar(options);
    nanobar.go(30);
    nanobar.go(76);
    nanobar.go(100);
  </script>

</body>

</html>