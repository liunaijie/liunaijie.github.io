---
title: mongo-复制集机制
date: 2020-04-14 13:25:33
categories:
- [coding, database]
tags: 
- mongo
---

# 原理

MongoDB复制集的主要意义在于实现服务高可用 它的现实依赖于两个方面的功能：

-   数据写入时将数据迅速的复制到另一个独立节点上
-   在接受写入的节点发生故障时自动选举出一个新的替代节点

在实现高可用的同时，复制集实现了其他几个附加功能：

-   数据分发：将数据从一个区域复制到另一个区域，减少另一个区域的读延迟
-   读写分离：不同类型的压力分别在不同的节点上执行
-   异地容灾：在数据中心故障时快速切换到异地

## 典型的复制集结构：

一个典型的复制集由3个以上具有投票权的节点组成，包括：

-   一个主节点（PRIMARY） 接受写入操作和选举时投票
    
-   两个（或多个）从节点（SECONDARY） 复制主节点上的新数据和选举时投票 大部分分布式都需要奇数节点，因为投票时可以避免相同票数的情况
    
    ![https://raw.githubusercontent.com/liunaijie/images/master/20200327175458.png](https://raw.githubusercontent.com/liunaijie/images/master/20200327175458.png)
    

### 数据如何复制的

当一个修改操作，无论是插入，更新或删除，到达主节点时，它对数据的操作将被记录下来（经过一些必要的转换），这些记录称为oplog。 当接到通过主节点上打开tailable游标不断获取新进入主节点的oplog，并在自己的数据上回放，依次保存跟主节点上的数据一致。

### 通过选举完成故障恢复

-   具有投票权的节点之间两两互相发送心跳
-   当5次心跳未收到时判断为节点失联
-   如果失联的是主节点，从节点会发起选举，选出新的主节点
-   如果失联的是从节点则不会产生新的选举
-   选举基于 RAST一致性算法 实现，选举成功的必要条件是大多数投票节点存活
-   复制集中最多可以有50个节点，但具有投票权的节点最多7个

### 影响选举的因素

-   整个集群必须有大多数节点存活
-   被选举为主节点的节点必须：
    -   能够与多数节点建立连接
    -   具有较新的oplog
    -   具有较高的优先级（优先级可以配置）

### 复制集节点有以下常见的选配项：

-   是否具有投票权（v参数） 有则参与投票
-   优先级（priority参数） 优先级越高的节点的节点越优先成为主节点。优先级为0的节点无法成为主节点
-   隐藏(hidden参数) 复制数据，但对应用不可见。隐藏节点可以拥有投票权，但优先级必须为0，即不能成为主节点。**备份**
-   延迟（slaveDelay参数） 复制n秒之前的数据，保存与主节点的时间差。**容错**

# 注意事项

-   增加节点不会增加系统写性能！ 因为写的操作都是在主节点完成，增加节点并不能改变主节点的性能，所以不会增加系统的写性能。甚至会降低性能，因为当写请求发送到从节点，从节点需要将请求发送给主节点来完成，完成后再通过oplog发送给所有从节点。 但增加节点可以增加系统读性能

# 搭建

## 准备配置文件

```
systemLog:
    destination: file
    path: /data/db1/mongod.log #日志存放位置
    logAppend: true
storage:
    db: /data/db1 #数据存储位置
net:
    bindIp: 0.0.0.0 #开启其他机器访问
    port: 28017 #端口
relication:
    replSetName: rs0 #集群名称
processManagement:
    fork: true #将进程作为后台进程

```

## 启动

指定配置文件启动：`mongod -f /data/db1/mongod.conf`

## 配置复制集

进入Mongo shell中

```
rs.initiate({
    _id:"rs0",
    members:[{
        _id:0,
        host:"localhost:28017"
        },{
        _id:1,
        host:"localhost:28018"
        },{
        _id:2,
        host:"localhost:28019"
        }]
})

```

设置各个实例的ip地址和端口

## 验证

登录主节点进行写入，登录从节点进行读取，在登录从节点后如果直接进行读取会报错，需要先执行以下命令：

```
rs.test.find() # 报错
rs.slaveOk()
re.test.find() # 返回结果

```