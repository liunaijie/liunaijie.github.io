---
title: Hexo博客自动部署方案
date: 2024-11-25
categories:
  - publish
tags:
  - blog
---
更新记录下当前博客的写作, 同步, 发布方案.

目前使用`Hexo`来作为博客的生成框架, 使用`Github Action`来进行自动化部署.  
写作记录方面则是使用`Obsidian`来进行写作, 通过`Remote Sync`来进行多端同步, 同步到`OneDrive`云盘上, 来保证多设备之间的数据同步.   
同时我有一台`NAS`, 在`NAS`上也会通过`Cloud-Sync`将数据从`OneDrive`云盘下载, 再配合定时任务来监测是否有文件变动, 有变动则进行`Git`的提交. 
`Git`提交后则会触发`Github Action`来进行`Hexo`的构建和发布流程.
一个流程图大致是这样:
![](https://raw.githubusercontent.com/liunaijie/images/master/202411251431188.png)


以下是其中一些步骤的记录:

# Obsidian同步
之前一直使用`typora`来写文章, 但是后面一方面开始收费, 另外一方面发现`Obsidian`的功能更加强大, 所以就换到了`Obsidian`. 
使用`Obsidian`也有官方同步方案, 但是需要收费, 作为一名白嫖党, 肯定是不愿意花这个钱的, 所以就使用`Remote-Sync`来进行数据同步, 按照文档配置一下即可完成, 非常简单.
我使用`One Drive`的原因有几个
1. 这个国内也可以正常访问
2. 注册账号就有一些免费空间, 而同步的数据仅仅是一些文字, 图片. 总的体积也不会很大, 免费空间也足够使用了
3. 在手机端也可以使用

# NAS同步
使用`Obsidian`写作时, 我博客的内容仅仅是一个子文件夹, 使用`Cloud-Sync`可以指定要同步哪个文件夹到`NAS`的哪个目录上.
同时我使用`Hexo`来作为博客的框架, 会有一些其他文件内容, 我是没有放到`Obsidian`中的, 所以会有两个文件夹, 一个存放`Obsidian`中的文章内容, 一个存放`Hexo`的一些源文件.
通过软链将文件关联到源文件下. 

这个可以设置每天同步, 同步完成后再跟一个任务来检查`Git`文件是否有变动, 如果有变动, 则自动提交到`Github`
脚本内容为: 

```shell
#!/bin/bash

now=$(date +%Y-%m-%d)
if [ -n "git status -s" ];then
    git add .
    git commit -m  "update files on $now"
    git push
else 
echo "no changes on $now"    
fi
```

# Github Action.

其实`Hexo`的部署也可以在`NAS`上运行, 但是我不想在`NAS`上安装相关的依赖, 就使用了`Github Action`来完成此任务.
我的仓库中有两个分支
- `hexo` : 是`markdown`文件和`hexo`的配置文件
- `master` : 生成的`html`文件

使用`Github`的`user-name.github.io`仓库, 并关联到自己的域名上, 从而实现无服务器部署.

**设置私钥**
设置私钥到`user-name.github.io`仓库下，打开该仓库，找到`setting/secrets/New repository secret`将本地`~/.ssh/id_ras`文件复制进来，名称可以随便取，不过在下面使用的时候需要对应起来，比如我用了`ACTION_DEPLOY_KEY`这个名称。需要勾选 `Allow write access` 。


![](https://raw.githubusercontent.com/liunaijie/images/master/20210123154250.png)

**Action配置文件**

```yaml
name: Deploy Blog

on:
  push:
    branches:
      - hexo
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:   
          ref: hexo
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node - version: stable
      - name: Install required libs
        run: |
          npm install hexo-deployer-git --save          
          npm install hexo-generator-feed --save
      - name: Verify Node.js version
        run: node - v   
      - name: Setup hexo
        env:
          ACTION_DEPLOY_KEY: ${{ secrets.ACTION_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh/
          echo "$ACTION_DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config --global user.email "liunaijie1996@163.com"
          git config --global user.name "Jarvis"
          npm install hexo-cli -g
          npm install 
      - name: Hexo deploy
        run: |
          hexo clean
          hexo g
          hexo d
```


